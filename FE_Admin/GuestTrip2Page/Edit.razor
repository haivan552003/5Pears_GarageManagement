@page "/rentail_guest_trip/{id:int}"
@using Microsoft.AspNetCore.SignalR.Client
@using MudBlazor
@using System.Text.Json
@using System.Collections.Concurrent
@using System.Net
@inject HttpClient httpClient
@inject IJSRuntime js
@inject NavigationManager Navigation
@implements IAsyncDisposable
@inject ISnackbar Snackbar

<style>
    .fs-14 {
        font-size: 14px;
    }

    .text-gray {
        color: #637280;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255); /* Màu trắng với độ mờ 50% */
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999; /* Đảm bảo overlay hiển thị trên các thành phần khác */
    }
</style>
@if (isLoadingProgress)
{
    <div class="loading-overlay">
        <MudItem xs="12" Class="text-center">
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
        </MudItem>
    </div>
}
else
{
    <MudContainer Style="margin-top: 45px; margin-bottom: 25px;">
        <MudGrid>
            <MudItem xs="8">
                <MudPaper Class="p-4 mb-5" Elevation="1">
                    <MudGrid>
                        <MudItem xs="12" Class="mx-auto">
                            <MudText Typo="Typo.h6" Color="Color.Primary">Thông tin khách hàng</MudText>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField ShrinkLabel @bind-Value="addCus.phone_number" Label="Số điện thoại" Margin="Margin.Dense" Variant="Variant.Outlined" OnBlur="@SearchPhoneNumber" Required />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField ShrinkLabel @bind-Value="addCus.fullname" Label="Họ và tên" Margin="Margin.Dense" Variant="Variant.Outlined" Required />
                        </MudItem>
                        <MudItem xs="12" Class="d-flex justify-end">
                            @if (SaveButton)
                            {
                                <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" StartIcon="@Icons.Material.Outlined.Save" Color="Color.Primary" OnClick="AddCus">Lưu</MudButton>
                            }
                        </MudItem>
                    </MudGrid>
                </MudPaper>
                <MudPaper Class="p-4" Elevation="1">
                    <MudGrid>
                        <MudItem xs="12" Class="mx-auto">
                            <MudText Typo="Typo.h6" Color="Color.Primary">Chọn ghế</MudText>
                        </MudItem>

                        @{
                            int seatCount = car_seat.Count();
                        }
                        @if (seatCount == 17)
                        {
                            <MudItem xs="4">
                            </MudItem>
                            <MudItem xs="4">
                                <div class="bus-seat-layout">
                                    @foreach (var item in car_seat)
                                    {
                                        var isDisabled = item.status == "Đã đặt" || takenSeats.Contains(item.id.ToString()) || item.name.ToLower() == "tài xế";
                                        <button class="btn btn-outline-primary @((isDisabled ? "disabled" : "")) @(selectedSeats.Contains(item.id) ? "btn-outline-success" : "")"
                                                style="grid-row: @item.row; grid-column: @item.col;"
                                                disabled="@isDisabled"
                                                @onclick="() => OnSeatSelected(item.id, item.name)">
                                            @item.name
                                        </button>
                                    }
                                </div>
                            </MudItem>
                            <MudItem xs="4">
                                <MudGrid>
                                    <MudItem xs="12" Class="d-flex align-items-center">
                                        <MudIcon Icon="@Icons.Material.Filled.Chair" Color="Color.Default" />
                                        <MudText Typo="Typo.h6" Style="font-size: 12px;" Class="ml-1">Đã bán</MudText>
                                    </MudItem>
                                    <MudItem xs="12" Class="d-flex align-items-center">
                                        <MudIcon Icon="@Icons.Material.Filled.Chair" Color="Color.Primary" />
                                        <MudText Typo="Typo.h6" Style="font-size: 12px;" Class="ml-1">Còn trống</MudText>
                                    </MudItem>
                                    <MudItem xs="12" Class="d-flex align-items-center">
                                        <MudIcon Icon="@Icons.Material.Filled.Chair" Color="Color.Success" />
                                        <MudText Typo="Typo.h6" Style="font-size: 12px;" Class="ml-1">Đang chọn</MudText>
                                    </MudItem>
                                </MudGrid>
                            </MudItem>
                        }
                        else if (seatCount == 30)
                        {
                            <MudItem xs="3">
                            </MudItem>
                            <MudItem xs="5">
                                <div class="bus-seat-layout29">
                                    @foreach (var item in car_seat)
                                    {
                                        var isDisabled = item.status == "Đã đặt" || takenSeats.Contains(item.id.ToString()) || item.name.ToLower() == "tài xế";
                                        <button class="btn btn-outline-primary @((isDisabled ? "disabled" : "")) @(selectedSeats.Contains(item.id) ? "btn-outline-success" : "")"
                                                style="grid-row: @item.row; grid-column: @item.col;"
                                                disabled="@isDisabled"
                                                @onclick="() => OnSeatSelected(item.id, item.name)">
                                            @item.name
                                        </button>
                                    }
                                </div>
                            </MudItem>
                            <MudItem xs="4" Class="mt-4">
                                <MudGrid>
                                    <MudItem xs="12" Class="d-flex align-items-center">
                                        <MudIcon Icon="@Icons.Material.Filled.Chair" Color="Color.Default" />
                                        <MudText Typo="Typo.h6" Style="font-size: 12px;" Class="ml-1">Đã bán</MudText>
                                    </MudItem>
                                    <MudItem xs="12" Class="d-flex align-items-center">
                                        <MudIcon Icon="@Icons.Material.Filled.Chair" Color="Color.Primary" />
                                        <MudText Typo="Typo.h6" Style="font-size: 12px;" Class="ml-1">Còn trống</MudText>
                                    </MudItem>
                                    <MudItem xs="12" Class="d-flex align-items-center">
                                        <MudIcon Icon="@Icons.Material.Filled.Chair" Color="Color.Success" />
                                        <MudText Typo="Typo.h6" Style="font-size: 12px;" Class="ml-1">Đang chọn</MudText>
                                    </MudItem>
                                </MudGrid>
                            </MudItem>
                        }
                        else if (seatCount == 45)
                        {
                            <MudGrid>
                                <MudItem xs="3"></MudItem>
                                <MudItem xs="5">
                                    <div class="bus-seat-layout44">
                                        @foreach (var item in car_seat.Where(seat => int.Parse(seat.id.ToString()) % 2 != 0))
                                        {
                                            var isDisabled = item.status == "Đã đặt" || takenSeats.Contains(item.id.ToString()) || item.name.ToLower() == "tài xế";
                                            <button class="btn btn-outline-primary @((isDisabled ? "disabled" : "")) @(selectedSeats.Contains(item.id) ? "btn-outline-success" : "")"
                                                    style="grid-row: @item.row; grid-column: @item.col;"
                                                    disabled="@isDisabled"
                                                    @onclick="() => OnSeatSelected(item.id, item.name)">
                                                @item.name
                                            </button>
                                        }
                                    </div>
                                </MudItem>
                                <MudItem xs="4" Class="mt-6">
                                    <MudGrid>
                                        <MudItem xs="12" Class="d-flex align-items-center">
                                            <MudIcon Icon="@Icons.Material.Filled.Chair" Color="Color.Default" />
                                            <MudText Typo="Typo.h6" Style="font-size: 12px;" Class="ml-1">Đã bán</MudText>
                                        </MudItem>
                                        <MudItem xs="12" Class="d-flex align-items-center">
                                            <MudIcon Icon="@Icons.Material.Filled.Chair" Color="Color.Primary" />
                                            <MudText Typo="Typo.h6" Style="font-size: 12px;" Class="ml-1">Còn trống</MudText>
                                        </MudItem>
                                        <MudItem xs="12" Class="d-flex align-items-center">
                                            <MudIcon Icon="@Icons.Material.Filled.Chair" Color="Color.Success" />
                                            <MudText Typo="Typo.h6" Style="font-size: 12px;" Class="ml-1">Đang chọn</MudText>
                                        </MudItem>
                                    </MudGrid>
                                </MudItem>
                            </MudGrid>
                            <MudGrid>

                                <MudItem xs="3"></MudItem>
                                <MudItem xs="5">
                                    <div class="bus-seat-layout44">
                                        @foreach (var item in car_seat.Where(seat => int.Parse(seat.id.ToString()) % 2 == 0))
                                        {
                                            var isDisabled = item.status == "Đã đặt" || takenSeats.Contains(item.id.ToString()) || item.name.ToLower() == "tài xế";
                                            <button class="btn btn-outline-primary @((isDisabled ? "disabled" : "")) @(selectedSeats.Contains(item.id) ? "btn-outline-success" : "")"
                                                    style="grid-row: @item.row; grid-column: @item.col;"
                                                    disabled="@isDisabled"
                                                    @onclick="() => OnSeatSelected(item.id, item.name)">
                                                @item.name
                                            </button>
                                        }
                                    </div>
                                </MudItem>
                            </MudGrid>



                        }
                        else
                        {
                            <MudText>Số ghế không hợp lệ: @seatCount</MudText>
                        }
                        @*  <MudItem xs="4">
                    <MudGrid>
                    <MudItem xs="12" Class="d-flex align-items-center">
                    <MudIcon Icon="@Icons.Material.Filled.Chair" Color="Color.Default" />
                    <MudText Typo="Typo.h6" Style="font-size: 12px;" Class="ml-1">Đã bán</MudText>
                    </MudItem>
                    <MudItem xs="12" Class="d-flex align-items-center">
                    <MudIcon Icon="@Icons.Material.Filled.Chair" Color="Color.Primary" />
                    <MudText Typo="Typo.h6" Style="font-size: 12px;" Class="ml-1">Còn trống</MudText>
                    </MudItem>
                    <MudItem xs="12" Class="d-flex align-items-center">
                    <MudIcon Icon="@Icons.Material.Filled.Chair" Color="Color.Success" />
                    <MudText Typo="Typo.h6" Style="font-size: 12px;" Class="ml-1">Đang chọn</MudText>
                    </MudItem>
                    </MudGrid>
                    </MudItem> *@

                        <MudItem xs="10">
                            <MudGrid>
                                @foreach (var item in car_seat)
                                {
                                    var isDisabled = item.status == "Đã đặt" || takenSeats.Contains(item.id.ToString()) || item.name.ToLower() == "tài xế"; ;
                                    var buttonColor = selectedSeats.Contains(item.id) ? Color.Success : Color.Primary;

                                    <MudItem xs="2">
                                        <MudButton Variant="Variant.Outlined"
                                                   Color="@buttonColor"
                                                   Size="Size.Small"
                                                   Disabled="@isDisabled"
                                                   OnClick="() => OnSeatSelected(item.id, item.name)">
                                            @item.name
                                        </MudButton>
                                    </MudItem>
                                }
                            </MudGrid>
                        </MudItem>
                        <MudItem xs="2">
                            <MudGrid>
                                <MudItem xs="12" Class="d-flex align-items-center">
                                    <MudIcon Icon="@Icons.Material.Filled.Chair" Color="Color.Default" />
                                    <MudText Typo="Typo.h6" Style="font-size: 12px;" Class="ml-1">Đã bán</MudText>
                                </MudItem>
                                <MudItem xs="12" Class="d-flex align-items-center">
                                    <MudIcon Icon="@Icons.Material.Filled.Chair" Color="Color.Primary" />
                                    <MudText Typo="Typo.h6" Style="font-size: 12px;" Class="ml-1">Còn trống</MudText>
                                </MudItem>
                                <MudItem xs="12" Class="d-flex align-items-center">
                                    <MudIcon Icon="@Icons.Material.Filled.Chair" Color="Color.Success" />
                                    <MudText Typo="Typo.h6" Style="font-size: 12px;" Class="ml-1">Đang chọn</MudText>
                                </MudItem>
                            </MudGrid>
                        </MudItem>

                    </MudGrid>
                </MudPaper>

                @if (Dense_Radio == true)
                {
                    <MudPaper Class="p-4" Elevation="1">
                        <MudGrid>
                            <MudItem xs="12">
                                <MudText Typo="Typo.h6" Color="Color.Primary">Thông tin vé</MudText>
                            </MudItem>
                            <MudItem xs="3" Class="pb-2" Style="padding: 0px; padding-left: 12px;">
                                <MudText Typo="Typo.subtitle1" Color="Color.Default" Class="fs-14">Tuyến Xe</MudText>
                            </MudItem>
                            <MudItem xs="9" Class="pb-2" Style="padding: 0px; padding-right: 12px;">
                                <MudText Align="Align.End" Class="fw-bold fs-14" Typo="Typo.subtitle1">@TRIPDETAILS.from - @TRIPDETAILS.to</MudText>
                            </MudItem>

                            <MudItem xs="3" Class="pb-2" Style="padding: 0px; padding-left: 12px;">
                                <MudText Typo="Typo.subtitle1" Color="Color.Default" Class="fs-14">Khởi hành</MudText>
                            </MudItem>
                            <MudItem xs="9" Class="pb-2" Style="padding: 0px; padding-right: 12px;">
                                <MudText Align="Align.End" Class="fw-bold fs-14" Typo="Typo.subtitle1" Style="color: #00613D;">@TRIPDETAILS.time_start</MudText>
                            </MudItem>

                            <MudItem xs="4" Class="pb-2" Style="padding: 0px; padding-left: 12px;">
                                <MudText Typo="Typo.subtitle1" Color="Color.Default" Class="fs-14">Số Lượng Ghế</MudText>
                            </MudItem>
                            <MudItem xs="8" Class="pb-2" Style="padding: 0px; padding-right: 12px;">
                                <MudText Align="Align.End" Class="fw-bold fs-14" Typo="Typo.subtitle1">@selectedSeats.Count</MudText>
                            </MudItem>

                            <MudItem xs="3" Class="pb-2" Style="padding: 0px; padding-left: 12px;">
                                <MudText Typo="Typo.subtitle1" Color="Color.Default" Class="fs-14">Tên ghế</MudText>
                            </MudItem>
                            <MudItem xs="9" Class="pb-2" Style="padding: 0px; padding-right: 12px;">
                                <MudText Align="Align.End" Class="fw-bold fs-14" Typo="Typo.subtitle1"> @string.Join(", ", selectedSeatNames)</MudText>
                            </MudItem>
                        </MudGrid>
                    </MudPaper>

                    <MudItem xs="12" Style="margin-top:-5px;margin-bottom:10px;text-align:center">
                        <MudRadioGroup @bind-Value="Dense_Radio">
                            <MudRadio Value="true" Color="Color.Primary" Dense="true" Size="Size.Medium">
                                <MudText Typo="Typo.subtitle1" Color="Color.Default" Class="fs-16">Tiền Mặt</MudText>
                            </MudRadio>
                            <MudRadio Value="false" Color="Color.Secondary" Dense="false" Size="Size.Medium">
                                <MudText Typo="Typo.subtitle1" Color="Color.Default" Class="fs-16">Chuyển Khoản</MudText>
                            </MudRadio>
                        </MudRadioGroup>
                    </MudItem>


                    @if (Dense_Radio == true)
                    {
                        <MudPaper Class="p-4" Elevation="1">
                            <MudGrid>
                                <MudItem xs="12">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">Chi tiết giá</MudText>
                                </MudItem>

                                <MudItem xs="3" Class="pb-2" Style="padding: 0px; padding-left: 12px;">
                                    <MudText Typo="Typo.subtitle1" Color="Color.Default" Class="fs-14">Giá vé</MudText>
                                </MudItem>
                                <MudItem xs="9" Class="pb-2" Style="padding: 0px; padding-right: 12px;">
                                    <MudText Align="Align.End" Class="fw-bold fs-14" Typo="Typo.subtitle1">@TRIPDETAILS.price.ToString("#,##0") VNĐ</MudText>
                                </MudItem>

                                <MudItem xs="12">
                                    <MudTextField ShrinkLabel @bind-Value="_tienKhachDua" Label="Tiền khách đưa" Margin="Margin.Dense" Variant="Variant.Outlined" OnBlur="@CalculateChange" />
                                </MudItem>

                                <MudItem xs="12">
                                    <MudTextField ShrinkLabel @bind-Value="_tienThua" Label="Tiền thừa" Margin="Margin.Dense" Variant="Variant.Outlined" Disabled="true" />
                                </MudItem>

                                <MudItem xs="12" Class="pb-4">
                                    <MudDivider Style="border: 1px;" />
                                </MudItem>
                                <MudItem xs="3" Class="pb-2" Style="padding: 0px; padding-left: 12px;">
                                    <MudText Typo="Typo.subtitle1" Color="Color.Default" Class="fs-14">Tổng Tiền</MudText>
                                </MudItem>
                                <MudItem xs="9" Class="pb-2" Style="padding: 0px; padding-right: 12px;">
                                    <MudText Align="Align.End" Color="Color.Secondary" Class="fw-bold fs-14" Typo="Typo.subtitle1">@TRIPDETAILS.sale.ToString("#,##0") VNĐ</MudText>
                                </MudItem>

                                <MudItem xs="12">
                                    <MudButton Variant="Variant.Filled" Class="w-100" Color="Color.Primary" Size="Size.Medium" OnClick="@OnCheckout">Thanh Toán</MudButton>
                                </MudItem>

                            </MudGrid>
                        </MudPaper>
                        @if (errorMessageCheckCus != null)
                        {
                            <MudItem xs="12">
                                <MudText Color="Color.Error" Class="mt-2 text-center">
                                    @errorMessageCheckCus
                                </MudText>
                            </MudItem>
                        }

                    }
                    else
                    {
                        <MudPaper Class="p-4" Elevation="1">
                            <MudGrid>
                                <MudItem xs="12">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">Chi tiết giá</MudText>
                                </MudItem>

                                <MudItem xs="3" Class="pb-2" Style="padding: 0px; padding-left: 12px;">
                                    <MudText Typo="Typo.subtitle1" Color="Color.Default" Class="fs-14">Giá vé</MudText>
                                </MudItem>
                                <MudItem xs="9" Class="pb-2" Style="padding: 0px; padding-right: 12px;">
                                    <MudText Align="Align.End" Class="fw-bold fs-14" Typo="Typo.subtitle1">@TRIPDETAILS.price.ToString("#,##0") VNĐ</MudText>
                                </MudItem>
                                <MudItem xs="12" Class="pb-4">
                                    <MudDivider Style="border: 1px;" />
                                </MudItem>
                                <MudItem xs="3" Class="pb-2" Style="padding: 0px; padding-left: 12px;">
                                    <MudText Typo="Typo.subtitle1" Color="Color.Default" Class="fs-14">Tổng Tiền</MudText>
                                </MudItem>
                                <MudItem xs="9" Class="pb-2" Style="padding: 0px; padding-right: 12px;">
                                    <MudText Align="Align.End" Color="Color.Secondary" Class="fw-bold fs-14" Typo="Typo.subtitle1">@TRIPDETAILS.sale.ToString("#,##0") VNĐ</MudText>
                                </MudItem>

                                <MudItem xs="12">
                                    <MudButton Variant="Variant.Filled" Class="w-100" Color="Color.Primary" Size="Size.Medium" OnClick="@OnCheckout">Thanh Toán</MudButton>
                                </MudItem>
                            </MudGrid>
                        </MudPaper>
                        @if (errorMessageCheckCus != null)
                        {
                            <MudItem xs="12">
                                <MudText Color="Color.Error" Class="mt-2 text-center">
                                    @errorMessageCheckCus
                                </MudText>
                            </MudItem>
                        }
                    }
                }
            </MudItem>
        </MudGrid>
    </MudContainer>
}

<script>
    // Lấy token từ localStorage
    function getAuthToken() {
        return localStorage.getItem("authToken");
    }
</script>
<style>
    .bus-seat-layout, .bus-seat-layout29, .bus-seat-layout44 {
        display: grid;
        grid-gap: 10px;
        padding: 2px;
        justify-items: center;
    }

    .bus-seat-layout {
        grid-template-columns: repeat(4, 40px);
        grid-template-rows: repeat(5, 30px);
    }

    .bus-seat-layout29 {
        grid-template-columns: repeat(5, 40px);
        grid-template-rows: repeat(7, 30px);
    }

    .bus-seat-layout44 {
        grid-template-columns: repeat(5, 40px);
        grid-template-rows: repeat(7, 30px);
    }

    .btn {
        width: 40px;
        height: 35px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 10px;
        padding: 0;
    }

        .btn:disabled {
            cursor: not-allowed;
            background-color: lightgrey
        }

</style>
@code {
    private customer addCus = new customer();
    private string errorMessageCheckCus;
    private bool SaveButton = false;
    public bool Dense_Radio { get; set; } = true;
    private decimal _tienKhachDua = 0;
    private decimal _tienThua = 0;
    private bool isLoadingProgress = true;




    public string TextValue { get; set; }
    [Parameter] public int id { get; set; }
    private int cus_id;
    private HubConnection? hubConnection;
    private List<string> takenSeats = new List<string>();
    private trip trips;
    private TRIPDETAILS TRIPDETAILS = new TRIPDETAILS();
    private List<car_seat_rentail> car_seat = new List<car_seat_rentail>();
    private List<car_seat_not_null> car_seat_not_null;
    private customer customer = new customer();
    private string urlTrip = "http://localhost:49922/api/Trips/trip";
    private string urlCus = "http://localhost:49922/api/Customer";
    private string urlBill = "http://localhost:49922/api/GuestTrip";
    private string urlTopGuestTrip = "http://localhost:49922/api/GuestTrip/GetTop";
    private string urlViewTrip = "http://localhost:49922/api/Trips/viewTrip/";
    private string urlSeatNotNull = "http://localhost:49922/api/GuestTrip/GetSeatNotNull/";
    private string urlVNPayCreate = "http://localhost:49922/api/Payment/create-payment";


    private string urlGetTopCus = "http://localhost:49922/api/Customer/GetTop";
    private string urlUpdateStatusBill = "http://localhost:49922/api/GuestTrip/PutStatus2";

    private List<int> selectedSeats = new List<int>();
    private List<string> selectedSeatNames = new List<string>();
    private static ConcurrentDictionary<string, bool> userCheckoutStatus = new ConcurrentDictionary<string, bool>();

    private Timer? inactivityTimer;

    private guest_trip_create bill = new guest_trip_create();
    private Guest_Customer customers = new Guest_Customer();

    private int empId;
    private bool isHubConnected = false;


    protected override async Task OnInitializedAsync()
    {
        await LoadTripDetail();
        hubConnection = new HubConnectionBuilder()
             .WithUrl(Navigation.ToAbsoluteUri("http://localhost:49922/seatHub"))
             .Build();
        isLoadingProgress = false;
        StateHasChanged();

        // Xử lý chọn ghế từ các client khác
        hubConnection.On<int>("ReceiveSeatSelection", (seatId) =>
        {
            if (!takenSeats.Contains(seatId.ToString()))
            {
                takenSeats.Add(seatId.ToString());
                StateHasChanged();
            }
        });

        // Xử lý bỏ chọn ghế từ các client khác
        hubConnection.On<int>("ReceiveSeatDeselection", (seatId) =>
        {
            if (takenSeats.Contains(seatId.ToString()))
            {
                takenSeats.Remove(seatId.ToString());
                StateHasChanged();
            }
        });

        // Nhận toàn bộ danh sách ghế đã chọn khi client mới kết nối
        hubConnection.On<List<int>>("ReceiveAllSelectedSeats", (seatIds) =>
        {
            takenSeats = seatIds.Select(id => id.ToString()).ToList();
            StateHasChanged();
        });

        hubConnection.On("ReceiveCheckoutNotification", async () =>
         {
             await ReloadSeats();
             await InvokeAsync(() => StateHasChanged());
         });

        await hubConnection.StartAsync();

        // InitializeInactivityTimer();
    }

    private void InitializeInactivityTimer()
    {
        inactivityTimer = new Timer(async _ =>
        {
            if (hubConnection != null && hubConnection.State == HubConnectionState.Connected)
            {
                await hubConnection.StopAsync();
            }

            await InvokeAsync(() =>
            {
                Navigation.NavigateTo("http://localhost:5162/");
            });
        }, null, TimeSpan.FromMinutes(5), Timeout.InfiniteTimeSpan);

        InterceptUserActivity();
    }

    private async Task ResetInactivityTimer()
    {
        if (inactivityTimer != null)
        {
            inactivityTimer.Change(TimeSpan.FromSeconds(10), Timeout.InfiniteTimeSpan);
        }
    }

    private void InterceptUserActivity()
    {
        var dotNetRef = DotNetObjectReference.Create(this);
        js.InvokeVoidAsync("addEventListenersForActivity", dotNetRef);
    }

    [JSInvokable]
    public async Task UserActivityDetected()
    {
        await ResetInactivityTimer();
    }
    public bool IsConnected =>
        hubConnection?.State == HubConnectionState.Connected;

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }

    private async Task ReloadSeats()
    {
        var currentSelectedSeats = new List<int>(selectedSeats);

        var seatsResponse = await httpClient.GetFromJsonAsync<TRIPDETAILS>($"{urlViewTrip}{id}");
        if (seatsResponse != null)
        {
            TRIPDETAILS = seatsResponse;

            takenSeats = seatsResponse.car_seat
                .Where(seat => seat.status == "Đã đặt")
                .Select(seat => seat.id.ToString())
                .ToList();
            Console.WriteLine("Taken Seats: " + string.Join(", ", takenSeats));
        }

        selectedSeats = currentSelectedSeats;
        Console.WriteLine("Restored Selected Seats: " + string.Join(", ", selectedSeats));
    }


    private async Task LoadUser()
    {
        customer = await httpClient.GetFromJsonAsync<customer>($"{urlCus}/{cus_id}");
    }
    private async Task LoadTripDetail()
    {
        try
        {
            var response = await httpClient.GetFromJsonAsync<TRIPDETAILS>($"{urlViewTrip}{id}");
            TRIPDETAILS = response;
            car_seat = response.car_seat.ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

    private async Task OnSeatSelected(int seatId, string seatName)
    {
        if (selectedSeats.Contains(seatId))
        {
            selectedSeats.Remove(seatId);
            selectedSeatNames.Remove(seatName);

            if (hubConnection?.State == HubConnectionState.Connected)
            {
                await hubConnection.SendAsync("UnselectSeat", seatId);
            }
        }
        else
        {
            if (selectedSeats.Count < 5)
            {
                selectedSeats.Add(seatId);
                selectedSeatNames.Add(seatName);

                if (hubConnection?.State == HubConnectionState.Connected)
                {
                    await hubConnection.SendAsync("SelectSeat", seatId);
                }
            }
        }
        TRIPDETAILS.sale = (TRIPDETAILS.price - TRIPDETAILS.voucher) * selectedSeats.Count();
    }

    private async Task OnCheckout()
    {
        if (selectedSeats.Count() == 0)
        {
            errorMessageCheckCus = "Quý khách vui lòng chọn ghế.";
            return;
        }

        if (cus_id != 0)
        {
            bill.cus_id = cus_id;
        }
        else
        {
            if (string.IsNullOrWhiteSpace(addCus.fullname) ||
            string.IsNullOrWhiteSpace(addCus.phone_number))
            {
                errorMessageCheckCus = "Quý khách vui lòng điền đầy đủ thông tin hoặc đăng nhập.";
                return;
            }
            var response = await httpClient.GetAsync($"http://localhost:49922/api/Validate/CheckPhoneNumberCustomer/{addCus.phone_number}");
            if (response.StatusCode == HttpStatusCode.NotFound)
            {
                Console.WriteLine("Số điện thoại chưa được đăng ký, tiếp tục thêm khách hàng.");
                await AddCus();
            }
            else if (response.IsSuccessStatusCode)
            {
                var existingCustomer = await response.Content.ReadFromJsonAsync<Guest_Customer>();
                if (existingCustomer != null)
                {
                    cus_id = existingCustomer.id;
                    bill.cus_id = cus_id;
                    errorMessageCheckCus = "Thanh toán thành công";
                }
            }
            else
            {
                errorMessageCheckCus = "Đã xảy ra lỗi khi kiểm tra số điện thoại.";
                Console.WriteLine(errorMessageCheckCus);
            }
        }

        empId = await GetEmpIdFromToken();
        bill.emp_id = empId;

        if (selectedSeats.Count() == 1)
        {
            //1 ghế
            // bill.emp_id = 5;
            bill.trip_detail_id = id;
            bill.car_seat_id = selectedSeats.First();
            bill.parent_id = 0;
            bill.cus_id = cus_id;
            bill.price = TRIPDETAILS.sale;
            if (Dense_Radio == true)
            {
                bill.payment_method = true;
            }
            else
            {
                bill.payment_method = false;
            }

            var response = await httpClient.PostAsJsonAsync(urlBill, bill);
            if (response.IsSuccessStatusCode)
            {
                var responseTop = await httpClient.GetAsync(urlTopGuestTrip);
                var jsonResponse = await responseTop.Content.ReadAsStringAsync();
                Console.WriteLine("Response JSON: " + jsonResponse);

                var guestTrips = JsonSerializer.Deserialize<List<guest_trip>>(jsonResponse);
                var guestTripId = guestTrips.First().id;
                await js.InvokeVoidAsync("sessionStorage.setItem", "billId", guestTripId);


                var updateResponse = await httpClient.PutAsJsonAsync($"{urlUpdateStatusBill}/{guestTripId}", new
                {
                    id = guestTripId
                });
                Navigation.NavigateTo($"/checkout/{guestTripId}");


            }
            else
            {
                Console.WriteLine("Thêm thất bại");
            }
        }
        else
        {
            //nhiều ghế
            // bill.emp_id = 5;
            bill.trip_detail_id = id;
            bill.parent_id = 0;
            bill.car_seat_id = null;
            bill.cus_id = cus_id;
            bill.price = TRIPDETAILS.sale;

            var firstResponse = await httpClient.PostAsJsonAsync(urlBill, bill);
            if (firstResponse.IsSuccessStatusCode)
            {
                var responseTop = await httpClient.GetAsync(urlTopGuestTrip);
                var jsonResponse = await responseTop.Content.ReadAsStringAsync();
                var guestTrips = JsonSerializer.Deserialize<List<guest_trip>>(jsonResponse);
                var guestTripId = guestTrips.First().id;
                await js.InvokeVoidAsync("sessionStorage.setItem", "billId", guestTripId);
                Navigation.NavigateTo($"/checkout/{guestTripId}");



                var seatPrice = TRIPDETAILS.sale / selectedSeats.Count();
                bool allBillsCreatedSuccessfully = true;

                foreach (var seatId in selectedSeats)
                {
                    bill.car_seat_id = seatId;
                    bill.parent_id = guestTripId;
                    bill.price = seatPrice;
                    if (Dense_Radio == true)
                    {
                        bill.payment_method = true;
                    }
                    else
                    {
                        bill.payment_method = false;
                    }

                    var response = await httpClient.PostAsJsonAsync(urlBill, bill);
                    if (!response.IsSuccessStatusCode)
                    {
                        Console.WriteLine("Thêm ghế thất bại");
                    }
                    var updateResponse = await httpClient.PutAsJsonAsync($"{urlUpdateStatusBill}/{guestTripId}", new
                    {
                        id = guestTripId
                    });

                }
            }
            else
            {
                Console.WriteLine("Thêm thất bại");
            }
        }

    }

    private async Task SearchPhoneNumber()
    {
        if (string.IsNullOrWhiteSpace(addCus.phone_number))
        {
            addCus.fullname = string.Empty;
            SaveButton = false;
            return;
        }
        else
        {
            SaveButton = true;
        }
        var response = await httpClient.GetAsync($"http://localhost:49922/api/Validate/CheckPhoneNumberCustomer/{addCus.phone_number}");
        if (response.IsSuccessStatusCode)
        {
            var responseTop = await httpClient.GetAsync(urlTopGuestTrip);
            var jsonResponse = await responseTop.Content.ReadAsStringAsync();
            var guestTrips = JsonSerializer.Deserialize<List<guest_trip_create>>(jsonResponse);
            var guestTripId = guestTrips.First().id;
            var existingCustomer = await response.Content.ReadFromJsonAsync<Guest_Customer>();
            if (existingCustomer != null)
            {
                addCus.fullname = existingCustomer.fullname;
                addCus.Id = existingCustomer.id;
                SaveButton = false;
            }
            else
            {
                errorMessageCheckCus = "Số điện thoại chưa được đăng ký.";
                SaveButton = true;
            }
        }
        else if (response.StatusCode == HttpStatusCode.NotFound)
        {
            errorMessageCheckCus = "Số điện thoại không tồn tại.";
        }
        else
        {
            errorMessageCheckCus = $"Đã xảy ra lỗi khi kiểm tra số điện thoại. Mã lỗi: {response.StatusCode}";
            Console.WriteLine($"API Error: {response.StatusCode} - {await response.Content.ReadAsStringAsync()}");
        }
    }

    private async Task AddCus()
    {
        try
        {
            addCus.password = "123456";
            addCus.birthday = DateTime.Now.AddYears(-18);
            addCus.gender = 0;
            addCus.citizen_identity_img1 = null;
            addCus.citizen_identity_number = null;
            addCus.driver_license_img1 = null;
            addCus.driver_license_number = null;
            addCus.status = true;
            addCus.img_cus = null;
            var response = await httpClient.PostAsJsonAsync(urlCus, addCus);
            if (response.IsSuccessStatusCode)
            {
                var responseTop = await httpClient.GetAsync(urlGetTopCus);
                var jsonResponse = await responseTop.Content.ReadAsStringAsync();
                Console.WriteLine($"JSON Response: {jsonResponse}");
                Snackbar.Add("Khách hàng đã được thêm thành công!", Severity.Success);

                var customerTop = JsonSerializer.Deserialize<List<Guest_Customer>>(jsonResponse);
                if (customerTop != null && customerTop.Any())
                {
                    foreach (var customer in customerTop)
                    {
                        Console.WriteLine($"Customer ID: {customer.id}");
                    }
                    var cusID = customerTop.First().id;
                    Console.WriteLine(customerTop.FirstOrDefault().id);
                    bill.cus_id = cusID;
                }
                else
                {
                    Console.WriteLine("Danh sách khách hàng trả về rỗng hoặc null.");
                }
            }

        }
        catch (Exception ex)
        {
            Console.WriteLine($"Lỗi khi thêm khách hàng: {ex.Message}", Severity.Error);
        }
    }

    private void CalculateChange()
    {

        decimal priceValue = Convert.ToDecimal(TRIPDETAILS.sale);
        _tienThua = _tienKhachDua - priceValue;
        StateHasChanged();
        if (_tienThua <= 0)
        {
            _tienThua = 0;
        }
    }

    private async Task<int> GetEmpIdFromToken()
    {
        var token = await js.InvokeAsync<string>("localStorage.getItem", "authToken");

        if (!string.IsNullOrEmpty(token))
        {
            var handler = new System.IdentityModel.Tokens.Jwt.JwtSecurityTokenHandler();
            var jwtToken = handler.ReadJwtToken(token);

            var empIdClaim = jwtToken.Claims.FirstOrDefault(c => c.Type == "emp_id");
            if (empIdClaim != null)
            {
                return int.Parse(empIdClaim.Value);
            }
        }

        return 0;
    }

}




