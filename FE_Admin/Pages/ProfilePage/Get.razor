@page "/profile"
@inject HttpClient httpClient
@inject ISnackbar Snackbar
@inject IJSRuntime js
@inject NavigationManager navigationManager

<style>
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255); /* Màu trắng với độ mờ 50% */
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999; /* Đảm bảo overlay hiển thị trên các thành phần khác */
    }

</style>

@if (isLoading)
{
    <div class="loading-overlay">
        <MudItem xs="12" Class="text-center">
            <MudImage Src="/Image/404.jpg" Alt="NOT FOUND" Elevation="0" Fluid="true" />
        </MudItem>
    </div>
}

<MudContainer Class="mt-14 pa-0 fs-18" MaxWidth="MaxWidth.False">
    <MudGrid Class="pa-0">
        <MudItem xs="12">
            <MudPaper Elevation="0" Class="mb-3" Style="@($"color:{Colors.Grey.Darken4}; background:{Colors.Grey.Lighten4};")">
                <MudBreadcrumbs Class="pa-3" Items="_items"></MudBreadcrumbs>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudGrid Class="pa-0 mt-5 mb-5">
        <MudItem xs="8" Class="mx-auto">
            <MudItem xs="12" Class="mx-auto">
                <MudText Typo="Typo.h5" Color="Color.Primary" Class="fw-bold">Thông tin tài khoản</MudText>
            </MudItem>
            <MudItem xs="12" Class="mx-auto mt-1">
                <MudText Typo="Typo.h6" Style="color: #637280; font-size: 15px;">Quản lý thông tin hồ sơ tài khoản</MudText>
            </MudItem>
            <MudPaper Class="p-6 mt-5 mb-8" Outlined="true" Style="border-radius: 1rem !important;">
                

                <MudGrid Class="mt-8 mb-6">
                    <MudItem xs="4" Class="text-center">
                        <MudImage Src="@Employee.img_emp" Width="200" Height="200" Alt="Swedish Farm House" Elevation="3" Class="rounded-circle mb-5" />
                        <MudText Typo="Typo.h6">@Employee.fullname</MudText>

                        <MudText Typo="Typo.subtitle1" Style="@($"color:{Colors.Grey.Darken3};")">Ngày tạo: @Employee.date_create.ToShortDateString()</MudText>
                    </MudItem>

                    <MudItem xs="8">
                        <MudGrid>
                            <MudItem xs="3" Class="pa-5">
                                <MudText Style="@($"color:{Colors.Grey.Darken1};")" Class="pb-4" Typo="Typo.subtitle1">Mã nhân viên</MudText>
                                <MudText Style="@($"color:{Colors.Grey.Darken1};")" Class="pb-4" Typo="Typo.subtitle1">Email</MudText>
                                <MudText Style="@($"color:{Colors.Grey.Darken1};")" Class="pb-4" Typo="Typo.subtitle1">Số điện thoại</MudText>
                                <MudText Style="@($"color:{Colors.Grey.Darken1};")" Class="pb-4" Typo="Typo.subtitle1">Ngày sinh</MudText>
                                <MudText Style="@($"color:{Colors.Grey.Darken1};")" Class="pb-4" Typo="Typo.subtitle1">Giới tính</MudText>
                                <MudText Style="@($"color:{Colors.Grey.Darken1};")" Class="pb-4" Typo="Typo.subtitle1">Chức vụ</MudText>
                            </MudItem>
                            <MudItem xs="9" Class="text-start pa-5 pe-10">
                                <MudText Class="pb-4 fw-bold" Typo="Typo.subtitle1"><span class="pe-3">:</span>@Employee.emp_code</MudText>
                                <MudText Class="pb-4 fw-bold" Typo="Typo.subtitle1"><span class="pe-3">:</span>@Employee.email</MudText>
                                <MudText Class="pb-4 fw-bold" Typo="Typo.subtitle1"><span class="pe-3">:</span>@Employee.phone_number</MudText>
                                <MudText Class="pb-4 fw-bold" Typo="Typo.subtitle1"><span class="pe-3">:</span>@Employee.birthday.ToShortDateString()</MudText>

                                @if (Employee.gender)
                                {
                                    <MudText Class="pb-4 fw-bold" Typo="Typo.subtitle1"><span class="pe-3">:</span>Nam</MudText>
                                }
                                else
                                {
                                    <MudText Class="pb-4 fw-bold" Typo="Typo.subtitle1"><span class="pe-3">:</span>Nữ</MudText>
                                }

                                <MudText Class="pb-4 fw-bold" Typo="Typo.subtitle1"><span class="pe-3">:</span>@Employee.role_name</MudText>
                            </MudItem>
                        </MudGrid>
                    </MudItem>

                </MudGrid>
            </MudPaper>

            <MudItem xs="12" Class="mx-auto">
                <MudText Typo="Typo.h5" Color="Color.Primary" Class="fw-bold">Căn cước công dân</MudText>
            </MudItem>
            <MudPaper Class="p-4 mt-5" Outlined="true" Style="border-radius: 1rem !important;">

                <MudGrid Class="mx-auto">
                    <MudItem xs="6">
                        <MudText Class="pb-5 pt-5 fw-bold" Typo="Typo.h6">Hình ảnh</MudText>
                        <MudImage Fluid="true" Src="@Employee.citizen_identity_img" Alt="@Employee.citizen_identity_number" Class="mb-5" Style="border-radius: 1rem !important;" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Class="pb-5 pt-5 fw-bold" Typo="Typo.h6">Thông tin chung</MudText>

                        <MudText Style="@($"color:{Colors.Grey.Darken1};")" Typo="Typo.subtitle1">Số CCCD</MudText>
                        <MudTextField @bind-Value="@Employee.citizen_identity_number" Class="mb-3 me-10" Variant="Variant.Outlined" ReadOnly="true" />

                        <MudText Style="@($"color:{Colors.Grey.Darken1};")" Typo="Typo.subtitle1">Họ và tên</MudText>
                        <MudTextField @bind-Value="@Employee.fullname" Class="mb-3 me-10" Variant="Variant.Outlined" ReadOnly="true" />

                        <MudText Style="@($"color:{Colors.Grey.Darken1};")" Typo="Typo.subtitle1">Ngày sinh</MudText>
                        <MudTextField @bind-Value="@Employee.birthday" Class="mb-3 me-10" Variant="Variant.Outlined" ReadOnly="true" />
                    </MudItem>
                </MudGrid>
            </MudPaper>

        </MudItem>
    </MudGrid>
</MudContainer>

<script>
    // Lấy token từ localStorage
    function getAuthToken() {
        return localStorage.getItem("authToken");
    }
</script>

@code {
    private employees Employee = new employees();
    private string url = "http://localhost:49922/api/Employees";
    private int empId;
    private string userRole;
    private bool isInitialized = false;
    private bool isLoading = false;
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !isInitialized)
        {
            isInitialized = true;

            var token = await js.InvokeAsync<string>("localStorage.getItem", "authToken");

            if (!string.IsNullOrEmpty(token))
            {
                try
                {
                    var handler = new System.IdentityModel.Tokens.Jwt.JwtSecurityTokenHandler();

                    if (handler.CanReadToken(token))
                    {
                        var jwtToken = handler.ReadJwtToken(token);

                        var roleClaim = jwtToken.Claims.FirstOrDefault(c => c.Type == "http://schemas.microsoft.com/ws/2008/06/identity/claims/role");

                        if (roleClaim != null)
                        {
                            userRole = roleClaim.Value;
                        }
                        else
                        {
                            Console.WriteLine("Role claim not found in the token.");
                        }
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Lỗi khi giải mã token: {ex.Message}");
                }
            }
            CheckRole();
            StateHasChanged();
        }
    }

    private void CheckRole()
    {
        if (userRole == "1")
        {
            Console.WriteLine("User is an Admin.");
        }
        else if (userRole == "2")
        {
            Console.WriteLine("User is a regular User.");
        }
        else if (userRole == "3")
        {
            Console.WriteLine("User is a regular Driver.");
        }
        else
        {
            isLoading = true;
        }
    }


    private List<BreadcrumbItem> _items = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Thông tin tài khoản", href: null, icon: @Icons.Material.Outlined.PeopleOutline),
    };

    private bool isFirstRender = true;


}
