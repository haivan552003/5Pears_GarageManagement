@page "/editcar/{id:int}"
@inject HttpClient httpClient
@inject NavigationManager navigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.False" Class="mt-14 pa-0">
    <MudGrid>
        <MudItem xs="12">
            <MudPaper Elevation="0" Class="mb-3" Style="@($"color:{Colors.Grey.Darken4}; background:{Colors.Grey.Lighten4};")">
                <MudBreadcrumbs Class="pa-3" Items="_items"></MudBreadcrumbs>
            </MudPaper>
        </MudItem>
        <EditForm Model="@Car" OnValidSubmit="SubmitForm">
            <MudGrid>
                <MudItem xs="12" md="8">
                    <DataAnnotationsValidator />
                    <MudPaper Class="pa-4">
                        <MudText Typo="Typo.h5" Class="mb-4">Thông tin xe</MudText>
                        <MudGrid>
                            <MudItem xs="4">
                                <MudTextField Variant="Variant.Outlined" @bind-Value="Car.car_code" Label="Mã xe" ReadOnly="true" />
                            </MudItem>
                            <MudItem xs="4">
                                <MudTextField Variant="Variant.Outlined" @bind-Value="Car.car_number" Label="Biển số xe" Required="true" RequiredError="Biển số xe là bắt buột" />
                            </MudItem>
                            <MudItem xs="4">
                                <MudTextField Variant="Variant.Outlined" @bind-Value="Car.car_name" Label="Tên xe" Required="true" RequiredError="Tên xe là bắt buột" />
                            </MudItem>
                            <MudItem xs="4">
                                <MudTextField Variant="Variant.Outlined" @bind-Value="Car.fuel" Label="Nhiên liệu" Required="true" RequiredError="Nhiên liệu là bắt buột" />
                            </MudItem>
                            <MudItem xs="4">
                                <MudTextField Variant="Variant.Outlined" @bind-Value="Car.description" Label="Mô tả" Required="true" RequiredError="Mô tả là bắt buột" />
                            </MudItem>
                            <MudItem xs="4">
                                <MudTextField Variant="Variant.Outlined" @bind-Value="Car.insurance_fee" Label="Phí" Required="true" RequiredError="Phí là bắt buột" />
                            </MudItem>
                            <MudItem xs="4">
                                <MudTextField Variant="Variant.Outlined" @bind-Value="Car.color" Label="Màu xe" Required="true" RequiredError="Màu xe đi được là bắt buột" />
                            </MudItem>
                            <MudItem xs="4">
                                <MudDatePicker @bind-Value="Car.vehicle_registration_start" Label="Ngày đăng ký" Variant="Variant.Outlined" DateFormat="dd/MM/yyyy" MaxDate="@DateTime.Now" />
                            </MudItem>
                            <MudItem xs="4">
                                <MudDatePicker @bind-Value="Car.vehicle_registration_end" Label="Ngày hết hạn đăng ký" Variant="Variant.Outlined" DateFormat="dd/MM/yyyy" MaxDate="@DateTime.Now" />
                            </MudItem>
                            <MudItem xs="4">
                                <MudNumericField Variant="Variant.Outlined" @bind-Value="Car.price" Label="Giá xe" Required="true" RequiredError="Giá xe là bắt buộc" />
                            </MudItem>

                            <MudItem xs="4">
                                <MudSelect Variant="Variant.Outlined" @bind-Value="Car.status" Label="Trạng thái" Required="true" RequiredError="Trạng thái là bắt buộc">
                                    @*  <MudSelectItem Value="@("1")">Có sẵn</MudSelectItem>
                                    <MudSelectItem Value="@("2")">Đã thuê</MudSelectItem>
                                    <MudSelectItem Value="@("3")">Bảo trì</MudSelectItem> *@
                                    <MudSelectItem Value="1">Đang hoạt động</MudSelectItem>
                                    <MudSelectItem Value="2">Ngưng hoạt động</MudSelectItem>
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="4">
                                <MudSelect @bind-Value="Car.type_id" Label="Vai trò" Required="true" Variant="Variant.Outlined">
                                    @if (car_typess != null)
                                    {
                                        @foreach (var role in car_typess)
                                        {
                                            <MudSelectItem Value="role.id">@role.name</MudSelectItem>
                                        }
                                    }
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="4">
                                <MudSelect @bind-Value="Car.brand_id" Label="Vai trò" Required="true" Variant="Variant.Outlined">
                                    @if (car_brandss != null)
                                    {
                                        @foreach (var role in car_brandss)
                                        {
                                            <MudSelectItem Value="role.id">@role.name</MudSelectItem>
                                        }
                                    }
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="4">
                                <MudSelect @bind-Value="Car.isAuto"
                                           Label="Loại hộp số"
                                           Required="true"
                                           RequiredError="Vui lòng chọn loại hộp số"
                                           Variant="Variant.Outlined">
                                    <MudSelectItem Value="@((byte)0)">Số sàn</MudSelectItem>
                                    <MudSelectItem Value="@((byte)1)">Số tự động</MudSelectItem>
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="4">
                                <MudDatePicker @bind-Value="Car.year_production" Label="Năm sản xuất" Variant="Variant.Outlined" DateFormat="dd/MM/yyyy" MaxDate="@DateTime.Now" />
                            </MudItem>
                            <MudItem xs="4">
                                <MudNumericField Variant="Variant.Outlined" @bind-Value="Car.odo" Label="Số km đã đi" Required="true" RequiredError="Số km đã đi là bắt buộc" />
                            </MudItem>
                            <MudItem xs="4">
                                <MudNumericField Variant="Variant.Outlined" @bind-Value="Car.insurance_fee" Label="Phí bảo hiểm" Required="true" RequiredError="Phí bảo hiểm là bắt buộc" />
                            </MudItem>
                            <MudItem xs="12" Class="d-flex justify-end mt-4">
                                <MudButton Variant="Variant.Filled"
                                           Color="Color.Secondary"
                                           OnClick="Cancel"
                                           Class="mx-2">Hủy</MudButton>
                                <MudButton ButtonType="ButtonType.Submit"
                                           Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.Save">Lưu</MudButton>
                            </MudItem>
                        </MudGrid>

                    </MudPaper>
                </MudItem>

                <MudItem xs="12" md="4">
                    <MudPaper Elevation="3" Class="pa-4">
                        <MudText Typo="Typo.h6" Class="mb-4">Ghế</MudText>
                        <MudButton OnClick="OpenAddSeatDialog"
                                   Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Add"
                                   Class="mb-3">
                            Thêm ghế
                        </MudButton>
                        <MudGrid>
                            @foreach (var seat in CarSeats)
                            {
                                <MudItem xs="12">
                                    <MudCard>
                                        <MudCardContent>
                                            <MudGrid>
                                                <MudItem xs="9">
                                                    <MudText>@seat.name (Hàng: @seat.row, Cột: @seat.col)</MudText>
                                                </MudItem>
                                                <MudItem xs="3" Class="d-flex justify-end">
                                                    <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                                   Color="Color.Primary"
                                                                   OnClick="@(() => OpenEditSeatDialog(seat))" />
                                                </MudItem>
                                            </MudGrid>
                                        </MudCardContent>
                                    </MudCard>
                                </MudItem>
                            }
                        </MudGrid>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12">
                    <MudPaper Elevation="3" Class="pa-4">
                        <MudText Typo="Typo.h6" Class="mb-4">Hình ảnh xe</MudText>
                        <div class="d-flex gap-2 mb-3">
                            <MudButton OnClick="OpenAddImageDialog"
                                       Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Add">
                                Thêm ảnh
                            </MudButton>
                            <MudButton OnClick="DeleteSelectedImages"
                                       Variant="Variant.Filled"
                                       Color="Color.Error"
                                       StartIcon="@Icons.Material.Filled.Delete"
                                       Disabled="@(!SelectedImages.Any())">
                                Xóa ảnh đã chọn
                            </MudButton>
                        </div>

                        <MudGrid>

                            <MudItem xs="12">
                                <MudCard>
                                    <MudCardContent>
                                        <MudGrid>
                                            @foreach (var image in CarImages)
                                            {
                                                <MudItem xs="3" Class="mx-auto">
                                                    <MudCheckBox T="bool"
                                                                 Checked="@(SelectedImages.Contains(image.id))"
                                                                 CheckedChanged="@( (bool value) => OnImageSelected(value, image.id))" />
                                                    <img src="@image.name" class="img-fluid" style="width:250px; height: 200px" alt="Alternate Text" />
                                                    @* <MudText>@image.name</MudText> *@
                                                </MudItem>
                                            }
                                            @*  <MudItem xs="3" Class="d-flex justify-end">
                                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                            Color="Color.Primary"
                                            OnClick="@(() => OpenEditImageDialog(image))" />
                                            </MudItem> *@
                                        </MudGrid>
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>

                        </MudGrid>
                    </MudPaper>
                </MudItem>



            </MudGrid>
        </EditForm>
    </MudGrid>
</MudContainer>

@code {
    [Parameter] public int id { get; set; }

    private car_create Car = new car_create();
    private List<car_seat> CarSeats = new List<car_seat>();
    private List<car_img> CarImages = new List<car_img>();
    private HashSet<int> SelectedImages = new HashSet<int>();
    private string apiUrl = "http://localhost:49922/api";
    private DateTime? registrationStartDate;
    private DateTime? registrationEndDate;
    private DateTime? productionDate;
    // private List<dropdown> car_types = new List<dropdown>();
    // private List<dropdown> car_brands = new List<dropdown>();

    // private string typeUrl = "http://localhost:49922/api/Dropdown/car_type";
    // private string brandUrl = "http://localhost:49922/api/Dropdown/car_brand";

    private List<car_types> car_typess = new List<car_types>();
    private List<car_brands> car_brandss = new List<car_brands>();

    private string typeUrl = "http://localhost:49922/api/CarTypes";
    private string brandUrl = "http://localhost:49922/api/CarBrands";

    private List<BreadcrumbItem> _items = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Xe", "/", icon: Icons.Material.Outlined.DirectionsCar),
        new BreadcrumbItem("Danh sách xe", "/getcar", icon: Icons.Material.Outlined.List),
        new BreadcrumbItem("Chỉnh sửa xe", null, icon: Icons.Material.Outlined.Edit)
    };

    private async Task LoadType()
    {
        try
        {
            var response = await httpClient.GetFromJsonAsync<List<car_types>>(typeUrl);
            if (response != null)
            {
                car_typess = response;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Lỗi khi tải danh sách vai trò: {ex.Message}", Severity.Error);
        }
    }
    private async Task LoadBrand()
    {
        try
        {
            var response = await httpClient.GetFromJsonAsync<List<car_brands>>(brandUrl);
            if (response != null)
            {
                car_brandss = response;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Lỗi khi tải danh sách vai trò: {ex.Message}", Severity.Error);
        }
    }
    protected override async Task OnInitializedAsync()
    {
        await LoadCarAndSeats();
        await LoadCarImages();
        await LoadType();
        await LoadBrand();
    }
    private async Task OpenAddSeatDialog()
    {
        var parameters = new DialogParameters();
        parameters.Add("CarId", id);
        var dialog = DialogService.Show<EditSeat>("Thêm ghế mới", parameters);
        var result = await dialog.Result;

        if (!result.Cancelled)
        {
            var newSeat = (car_seat)result.Data;
            var response = await httpClient.PostAsJsonAsync($"{apiUrl}/Cars/PostCarSeat", newSeat);
            if (response.IsSuccessStatusCode)
            {
                await LoadCarAndSeats();
                Snackbar.Add("Thêm ghế mới thành công", Severity.Success);
            }
            else
            {
                Snackbar.Add("Lỗi khi thêm ghế mới", Severity.Error);
            }
        }
    }

    private async Task OpenEditSeatDialog(car_seat seat)
    {
        var parameters = new DialogParameters();
        parameters.Add("Seat", seat);
        parameters.Add("CarId", id);
        var dialog = DialogService.Show<EditSeat>("Chỉnh sửa thông tin ghế", parameters);
        var result = await dialog.Result;

        if (!result.Cancelled)
        {
            var updatedSeat = (car_seat)result.Data;
            var response = await httpClient.PutAsJsonAsync($"{apiUrl}/Cars/putCarSeat/{seat.id}", updatedSeat);
            if (response.IsSuccessStatusCode)
            {
                await LoadCarAndSeats();
                Snackbar.Add("Cập nhật thông tin ghế thành công", Severity.Success);
            }
            else
            {
                Snackbar.Add("Lỗi khi cập nhật thông tin ghế", Severity.Error);
            }
        }
    }

    private async Task LoadCarAndSeats()
    {
        try
        {
            var carResponse = await httpClient.GetFromJsonAsync<car_create>($"{apiUrl}/Cars/{id}");
            if (carResponse != null)
            {
                Car = carResponse;
                registrationStartDate = Car.vehicle_registration_start;
                registrationEndDate = Car.vehicle_registration_end;
                productionDate = Car.year_production;
            }

            // Load car seats
            var seatsResponse = await httpClient.GetFromJsonAsync<List<car_seat>>($"{apiUrl}/Cars/getCarSeats/{id}");
            if (seatsResponse != null)
            {
                CarSeats = seatsResponse;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Xe chưa có ghế, vui lòng thêm ghế", Severity.Warning);
        }
    }

    private async Task SubmitForm()
    {
        try
        {
            if (registrationStartDate.HasValue)
                Car.vehicle_registration_start = registrationStartDate.Value;
            if (registrationEndDate.HasValue)
                Car.vehicle_registration_end = registrationEndDate.Value;
            if (productionDate.HasValue)
                Car.year_production = productionDate.Value;
            var carResponse = await httpClient.PutAsJsonAsync($"{apiUrl}/Cars/putCars/{id}", Car);
            if (!carResponse.IsSuccessStatusCode)
            {
                throw new Exception($"Lỗi cập nhật thông tin xe: {await carResponse.Content.ReadAsStringAsync()}");
            }
            foreach (var seat in CarSeats)
            {
                var seatResponse = await httpClient.PutAsJsonAsync($"{apiUrl}/Cars/putCarSeat/{seat.id}", seat);
                if (!seatResponse.IsSuccessStatusCode)
                {
                    throw new Exception($"Lỗi cập nhật thông tin ghế: {await seatResponse.Content.ReadAsStringAsync()}");
                }
            }

            Snackbar.Add("Cập nhật thành công", Severity.Success);
            navigationManager.NavigateTo("/getcar");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Lỗi: {ex.Message}", Severity.Error);
        }
    }
    private async Task LoadCarImages()
    {
        try
        {
            var response = await httpClient.GetFromJsonAsync<List<car_img>>($"{apiUrl}/Cars/GetImgById/{id}");
            if (response != null)
            {
                CarImages = response;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Chưa có ảnh xe nào được thêm", Severity.Info);
        }
    }

    private async Task OpenAddImageDialog()
    {
        var parameters = new DialogParameters();
        parameters.Add("CarId", id);
        var dialog = DialogService.Show<EditImg>("Thêm nhiều ảnh", parameters);
        var result = await dialog.Result;

        if (!result.Cancelled)
        {
            var newImages = (List<car_img>)result.Data;
            try
            {
                var tasks = newImages.Select(img =>
                    httpClient.PostAsJsonAsync($"{apiUrl}/Cars/CreateImg", img));

                var responses = await Task.WhenAll(tasks);

                if (responses.All(r => r.IsSuccessStatusCode))
                {
                    await LoadCarImages();
                    Snackbar.Add("Thêm ảnh mới thành công", Severity.Success);
                }
                else
                {
                    Snackbar.Add("Có lỗi xảy ra khi thêm một số ảnh", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Lỗi khi thêm ảnh mới: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task OpenEditImageDialog(car_img image)
    {
        var parameters = new DialogParameters();
        parameters.Add("Image", image);
        parameters.Add("CarId", id);
        var dialog = DialogService.Show<EditImg>("Chỉnh sửa thông tin ảnh", parameters);
        var result = await dialog.Result;

        if (!result.Cancelled)
        {
            var updatedImage = (car_img)result.Data;
            var response = await httpClient.PutAsJsonAsync($"{apiUrl}/Cars/updateImg/{image.id}", updatedImage);
            if (response.IsSuccessStatusCode)
            {
                await LoadCarImages();
                Snackbar.Add("Cập nhật thông tin ảnh thành công", Severity.Success);
            }
            else
            {
                Snackbar.Add("Lỗi khi cập nhật thông tin ảnh", Severity.Error);
            }
        }
    }

    private void OnImageSelected(bool isChecked, int imageId)
    {
        if (isChecked)
        {
            SelectedImages.Add(imageId);
        }
        else
        {
            SelectedImages.Remove(imageId);
        }
    }

    private async Task DeleteSelectedImages()
    {
        if (!SelectedImages.Any()) return;

        var parameters = new DialogParameters
        {
            { "ContentText", $"Bạn có chắc chắn muốn xóa {SelectedImages.Count} ảnh đã chọn không?" },
            { "ButtonText", "Xóa" },
            { "Color", Color.Error }
        };

        var dialog = DialogService.Show<DeleteImg>("Xác nhận xóa", parameters);
        var result = await dialog.Result;

        if (!result.Cancelled)
        {
            try
            {
                var deleteTasks = SelectedImages.Select(imageId =>
                    httpClient.DeleteAsync($"{apiUrl}/Cars/deleteImg/{imageId}"));

                var results = await Task.WhenAll(deleteTasks);

                if (results.All(r => r.IsSuccessStatusCode))
                {
                    await LoadCarImages();
                    SelectedImages.Clear();
                    Snackbar.Add("Xóa ảnh thành công", Severity.Success);
                }
                else
                {
                    Snackbar.Add("Có lỗi xảy ra khi xóa một số ảnh", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Lỗi: {ex.Message}", Severity.Error);
            }
        }
    }

    private void Cancel()
    {
        navigationManager.NavigateTo("/cars");
    }
}