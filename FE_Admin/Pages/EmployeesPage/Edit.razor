@page "/editemp/{Id:int}"
@inject HttpClient httpClient
@inject ISnackbar Snackbar
@inject NavigationManager navigationManager

<MudContainer Class="mt-14 pa-0" MaxWidth="MaxWidth.False">
    <MudGrid Class="pa-0">
        <MudItem xs="12">
            <MudPaper Elevation="0" Class="mb-3" Style="@($"color:{Colors.Grey.Darken4}; background:{Colors.Grey.Lighten4};")">
                <MudBreadcrumbs Class="pa-3" Items="_items"></MudBreadcrumbs>
            </MudPaper>
        </MudItem>

        <MudGrid xs="10" Class="mx-auto">
            <MudPaper Class="mud-paper mud-elevation-4 p-8" Style="margin-right: 16px; padding: 30px">
                <MudText Typo="Typo.h6" Class="mb-5">Thêm Nhân Viên</MudText>

                <MudForm @ref="form">
                    <MudGrid Gutter="true">
                        <MudItem xs="6" Class="mb-4">
                            <InputFile id="licenseInput2" OnChange="HandleFileSelected" accept="image/*" style="display: none;" />
                            @if (!string.IsNullOrEmpty(Employee.img_emp))
                            {
                                <MudImage Fluid="false" Src="@Employee.img_emp" Class="rounded-lg mb-2 w-100 mx-auto d-block" Height="260" />
                            }
                            <MudButton HtmlTag="label" For="licenseInput2" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Secondary"
                                       StartIcon="@Icons.Material.Outlined.CloudUpload"
                                       FullWidth="true" Class="mud-button-small-text">
                                Ảnh đại diện
                            </MudButton>
                        </MudItem>
                       @*  <MudItem xs="6" Class="mb-4">
                            <InputFile id="licenseInput3" OnChange="HandleFileSelected" accept="image/*" style="display: none;" />
                            @if (!string.IsNullOrEmpty(imagePreviewUrl1))
                            {
                                <MudImage Fluid="false" Src="@imagePreviewUrl1" Class="rounded-lg mb-2 w-100 mx-auto d-block" Height="280" />
                            }
                            <MudButton HtmlTag="label" For="licenseInput3" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Secondary"
                                       StartIcon="@Icons.Material.Outlined.CloudUpload"
                                       FullWidth="true" Class="mud-button-small-text">
                                Căn cước công dân
                            </MudButton>
                        </MudItem> *@
                        <MudItem xs="6" Class="mb-4">
                            <MudTextField Label="Mã nhân viên" @bind-Value="Employee.emp_code" Placeholder="Mã Nhân Viên"
                                          Variant="Variant.Outlined" Required="true" ReadOnly="true"
                                          LabelStyle="font-weight: 600; color: #1976d2;" />
                        </MudItem>

                        <MudItem xs="6" Class="mb-4">
                            <MudTextField Label="Họ và tên" @bind-Value="Employee.fullname" Placeholder="Họ Và Tên"
                                          Variant="Variant.Outlined" Required="true"
                                          Validation="@(new Func<string, IEnumerable<string>>(EmployeeValidateFullName))"
                                          LabelStyle="font-weight: 600; color: #1976d2;" />
                        </MudItem>

                        <MudItem xs="6" Class="mb-4">
                            <MudTextField Label="Email" @bind-Value="Employee.email" Placeholder="Email"
                                          Variant="Variant.Outlined" Required="true"
                                          Validation="@(new Func<string, Task<IEnumerable<string>>>(EmployeeValidateEmail))"
                                          LabelStyle="font-weight: 600; color: #1976d2;" />
                        </MudItem>
                        <MudItem xs="6" Class="mb-4">
                            <MudTextField Label="Số điện thoại" @bind-Value="Employee.phone_number" Placeholder="Họ Và Tên"
                                          Variant="Variant.Outlined" Required="true"
                                          LabelStyle="font-weight: 600; color: #1976d2;" />
                        </MudItem>
                        <MudItem xs="6" Class="mb-4">
                            <MudTextField Label="Số CMND" @bind-Value="Employee.citizen_identity_number"
                                          Placeholder="Số CMND" Variant="Variant.Outlined"
                                          LabelStyle="font-weight: 600; color: #1976d2;" />
                        </MudItem>

                        <MudItem xs="6" Class="mb-4">
                            <MudDatePicker @bind-Date="birthdayDate" Label="Ngày sinh" Required="true"
                                           Placeholder="Ngày Sinh" Variant="Variant.Outlined"
                                           LabelStyle="font-weight: 600; color: #1976d2;" />
                        </MudItem>

                        <MudItem xs="6" Class="mb-4">
                            <MudTextField Label="Mật khẩu"
                                          @bind-Value="Employee.password"
                                          Placeholder="Mật Khẩu"
                                          Variant="Variant.Outlined"
                                          Required="true"
                                          InputType="@PasswordInput"
                                          Adornment="Adornment.End"
                                          AdornmentIcon="@PasswordInputIcon"
                                          OnAdornmentClick="TogglePasswordVisibility"
                                          AdornmentAriaLabel="Show Password"
                                          Validation="@(new Func<string, IEnumerable<string>>(EmployeeValidatePassword))"
                                          LabelStyle="font-weight: 600; color: #1976d2;" />
                        </MudItem>



                        <MudItem xs="4" Class="mb-4">
                            <MudSelect @bind-Value="Employee.status" Label="Trạng thái" Required="true"
                                       Placeholder="Trạng Thái" Variant="Variant.Outlined"
                                       LabelStyle="font-weight: 600; color: #1976d2;">
                                <MudSelectItem Value="true">Đang hoạt động</MudSelectItem>
                                <MudSelectItem Value="false">Ngưng hoạt động</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="4" Class="mb-4">
                            <MudSelect Label="Giới tính" @bind-Value="Employee.gender" Placeholder="Giới Tính"
                                       Variant="Variant.Outlined" Required="true"
                                       Validation="@(new Func<string, IEnumerable<string>>(EmployeeValidateGender))"
                                       LabelStyle="font-weight: 600; color: #1976d2;">
                                <MudSelectItem Value="true">Nam</MudSelectItem>
                                <MudSelectItem Value="false">Nữ</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="4">
                            <MudSelect @bind-Value="Employee.role_id" Label="Vai trò" Required="true" Variant="Variant.Outlined">
                                @if (roles != null)
                                {
                                    @foreach (var role in roles)
                                    {
                                        <MudSelectItem Value="role.id">@role.name</MudSelectItem>
                                    }
                                }
                            </MudSelect>
                        </MudItem>

                        <MudItem xs="12" Class="d-flex justify-end">
                            <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Outlined.Save"
                                       Color="Color.Primary" OnClick="EditEmployee" Class="mt-3">Lưu</MudButton>
                        </MudItem>
                    </MudGrid>
                </MudForm>
            </MudPaper>
        </MudGrid>
    </MudGrid>
</MudContainer>

@code {
    [Parameter] public int Id { get; set; }
    private IBrowserFile selectedFile;
    private IBrowserFile selectedFile1;
    private string imagePreviewUrl;
    private string imagePreviewUrl1;
    private string roleUrl = "http://localhost:49922/api/Roles";
    private List<roles> roles = new List<roles>();
    private employees Employee = new employees();
    private bool isFormValid = false;
    private DateTime? birthdayDate;
    private MudForm form;
    private string url = "http://localhost:49922/api/Employees";


    private List<BreadcrumbItem> _items = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Nhân viên", href: "/getemp", icon: @Icons.Material.Outlined.PeopleOutline),
        new BreadcrumbItem("Danh sách nhân viên", href: "/getemp", icon: @Icons.Material.Outlined.List),
        new BreadcrumbItem("Chỉnh sửa nhân viên", href: "", icon: @Icons.Material.Filled.Edit),
    };

    private bool isShowPassword = false;
    private InputType PasswordInput => isShowPassword ? InputType.Text : InputType.Password;
    private string PasswordInputIcon => isShowPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;

    private void TogglePasswordVisibility()
    {
        isShowPassword = !isShowPassword; // Đảo giá trị hiển thị mật khẩu
    }

    protected override async Task OnInitializedAsync()
    {
        var response = await httpClient.GetFromJsonAsync<employees>(url + "/" + Id);
        Employee = response;
        await LoadDriver();
        await LoadRoles();
    }

    private async Task LoadDriver()
    {
        try
        {
            Employee = await httpClient.GetFromJsonAsync<employees>($"{url}/{Id}");
            if (Employee != null)
            {
                birthdayDate = Employee.birthday;
            }
            else
            {
                Snackbar.Add("Không tìm thấy thông tin tài xế", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Lỗi khi tải thông tin tài xế: {ex.Message}", Severity.Error);
        }
    }


    private async Task EditEmployee()
    {
        try
        {
            var response = await httpClient.PutAsJsonAsync(url + "/" + Id, Employee);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add($"Chỉnh sửa nhân viên {Employee.fullname} thành công", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Chỉnh sửa {Employee.fullname} thất bại" + response, Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Có lỗi xảy ra: {ex.Message}", Severity.Error);
        }
    }


    private void Cancel()
    {
        navigationManager.NavigateTo("/getemp");
    }
    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;

        if (selectedFile != null)
        {
            var stream = selectedFile.OpenReadStream();
            var buffer = new byte[selectedFile.Size];
            await stream.ReadAsync(buffer, 0, buffer.Length);
            stream.Close();

            imagePreviewUrl = $"data:image/jpeg;base64,{Convert.ToBase64String(buffer)}";
        }
        else
        {
            Console.WriteLine("No file selected.");
        }
    }

    private async Task<string> GetBase64Image(IBrowserFile file)
    {
        var buffer = new byte[file.Size];
        await file.OpenReadStream().ReadAsync(buffer);
        return Convert.ToBase64String(buffer);
    }


    private async Task<bool> IsEmailExists(string email)
    {
        var response = await httpClient.GetAsync($"{url}/exists?email={email}");
        return response.IsSuccessStatusCode && bool.Parse(await response.Content.ReadAsStringAsync());
    }

    private async Task<IEnumerable<string>> EmployeeValidateEmail(string email)
    {
        var errors = new List<string>();

        if (string.IsNullOrWhiteSpace(email))
        {
            errors.Add("Vui lòng điền email.");
        }
        else if (email.Length < 20 || email.Length > 150)
        {
            errors.Add("Email không hợp lệ.");
        }
        else
        {
            if (await IsEmailExists(email))
            {
                errors.Add("Email đã tồn tại trong cơ sở dữ liệu.");
            }
        }

        return errors;
    }

    private IEnumerable<string> EmployeeValidateEmpCode(string empCode)
    {
        if (string.IsNullOrWhiteSpace(empCode))
        {
            yield return "Vui lòng điền mã nhân viên.";
        }
    }

    private IEnumerable<string> EmployeeValidatePassword(string password)
    {
        if (string.IsNullOrWhiteSpace(password))
        {
            yield return "Vui lòng điền mật khẩu.";
        }
        else if (password.Length < 8 || password.Length > 15)
        {
            yield return "Mật khẩu không hợp lệ.";
        }
        else if (!password.Any(char.IsUpper) || !password.Any(char.IsLower) ||
                 !password.Any(char.IsDigit) || !password.Any(ch => "!@#$%^&*()_+[]{}|;':\",.<>?/`~".Contains(ch)))
        {
            yield return "Mật khẩu phải chứa ít nhất một chữ hoa, một chữ thường, một số và một ký tự đặc biệt.";
        }
    }

    private IEnumerable<string> EmployeeValidateFullName(string fullName)
    {
        if (string.IsNullOrWhiteSpace(fullName))
        {
            yield return "Vui lòng điền họ và tên.";
        }
        else if (fullName.Length < 5 || fullName.Length > 150)
        {
            yield return "Họ và tên không hợp lệ.";
        }
        else if (fullName.Any(ch => !char.IsLetter(ch) && !char.IsWhiteSpace(ch)))
        {
            yield return "Họ và tên không được chứa ký tự đặc biệt.";
        }
    }

    private IEnumerable<string> EmployeeValidateRoleID(string roleId)
    {
        if (string.IsNullOrWhiteSpace(roleId))
        {
            yield return "Vui lòng điền ID vai trò.";
        }
        else if (!int.TryParse(roleId, out _))
        {
            yield return "ID vai trò không hợp lệ .";
        }
    }

    private IEnumerable<string> EmployeeValidateGender(string gender)
    {
        if (string.IsNullOrWhiteSpace(gender))
        {
            yield return "Vui lòng chọn giới tính.";
        }
    }

    private IEnumerable<string> EmployeeValidateCitizenIdentity(string citizenIdentityNumber, string citizenIdentityImg)
    {
        if (!string.IsNullOrWhiteSpace(citizenIdentityNumber) && string.IsNullOrWhiteSpace(citizenIdentityImg))
        {
            yield return "Nếu có số CCCD thì hình ảnh CCCD không được bỏ trống.";
        }
        else if (string.IsNullOrWhiteSpace(citizenIdentityNumber) && !string.IsNullOrWhiteSpace(citizenIdentityImg))
        {
            yield return "Nếu có hình ảnh CCCD thì số CCCD không được bỏ trống.";
        }
        else if (!string.IsNullOrWhiteSpace(citizenIdentityNumber) && citizenIdentityNumber.Length != 12 && citizenIdentityNumber.Length != 12)
        {
            yield return "Số CCCD không hợp lệ.";
        }
    }

    private async Task LoadRoles()
    {
        try
        {
            var response = await httpClient.GetFromJsonAsync<List<roles>>(roleUrl);
            if (response != null)
            {
                roles = response;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Lỗi khi tải danh sách vai trò: {ex.Message}", Severity.Error);
        }
    }
}
