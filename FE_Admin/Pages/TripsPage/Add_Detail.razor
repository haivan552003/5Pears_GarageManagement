@inject MudBlazor.ISnackbar Snackbar
@inject HttpClient httpClient // Thêm inject HttpClient


<MudDialog MaxWidth="MaxWidth.Medium">
    <DialogContent>
        <MudPaper Elevation="0">
            <MudText Typo="Typo.h6" Class="mb-5">@ContentText</MudText>
            <MudForm @ref="form">
                <MudGrid Gutter="true">
                    <MudItem xs="6" Class="mx-auto">
                        <MudTextField Label="Mã CT chuyến đi" @bind-Value="SelectedTrip.trip_detail_code"
                                      Placeholder="Nhập mã CT chuyến đi" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="6" Class="mb-4">
                        <MudNumericField T="float" Label="Khoảng cách" @bind-Value="SelectedTrip.distance"
                                         Placeholder="Nhập khoảng cách" Variant="Variant.Outlined" Required="true" />
                    </MudItem>
                    <MudItem xs="6" Class="mb-4">
                        <MudTextField T="float" Label="Giá" @bind-Value="SelectedTrip.price"
                                      Placeholder="Nhập giá" Variant="Variant.Outlined" Required="true" />
                    </MudItem>
                    <MudItem xs="6" Class="mb-4">
                        <MudSelect @bind-Value="SelectedTrip.driver_id" Label="Mã Tài Xế" Variant="Variant.Outlined" Required="true">
                            @foreach (var driver in drivers)
                            {
                                <MudSelectItem Value="@driver.id">@driver.name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="6" Class="mb-4">
                        <MudSelect @bind-Value="SelectedTrip.location_from_id" Label="Điểm đến" Variant="Variant.Outlined" Required="true">
                            @foreach (var location in locationsfrom)
                            {
                                <MudSelectItem Value="@location.id">@location.name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="6" Class="mb-4">
                        <MudSelect @bind-Value="SelectedTrip.car_id" Label="Xe" Variant="Variant.Outlined" Required="true">
                            @foreach (var car in cars)
                            {
                                <MudSelectItem Value="@car.id">@car.name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="6" Class="mb-4">
                        <MudSelect @bind-Value="SelectedTrip.location_to_id" Label="Điểm khởi hành" Variant="Variant.Outlined" Required="true">
                            @foreach (var locations in locationsto)
                            {
                                <MudSelectItem Value="@locations.id">@locations.name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="6" Class="mb-4">
                        <MudSelect Variant="Variant.Outlined" @bind-Value="SelectedTrip.status" Label="Trạng thái" Required="true" RequiredError="Trạng thái là bắt buộc">
                            <MudSelectItem Value="true">Đang hoạt động</MudSelectItem>
                            <MudSelectItem Value="false">Ngưng hoạt động</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="6" Class="mb-4">
                        <MudTextField Label="Thời gian bắt đầu" @bind-Value="SelectedTrip.time_start"
                                      Placeholder="Bắt đầu" Variant="Variant.Outlined" Required="true" />
                    </MudItem>
                    <MudItem xs="6" Class="mb-4">
                        <MudTextField Label="Thời gian kết thúc" @bind-Value="SelectedTrip.time_end"
                                      Placeholder="Kết thúc" Variant="Variant.Outlined" Required="true" />
                    </MudItem>
                    <MudItem xs="12" Class="mb-4">
                        <MudTextField Label="Voucher" @bind-Value="SelectedTrip.voucher"
                                      Placeholder="Mã voucher" Variant="Variant.Outlined" Required="true" />
                    </MudItem>
                </MudGrid>
            </MudForm>
        </MudPaper>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Color="Color.Secondary">Hủy</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit">Lưu</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }
    [Parameter] public string ContentText { get; set; }
    [Parameter]
    public trip_detail_create SelectedTrip { get; set; } = new trip_detail_create();

    private MudForm form;


    private List<dropdown> drivers = new List<dropdown>();
    private List<dropdown> locationsfrom = new List<dropdown>(); // điểm đến
    private List<dropdown> cars = new List<dropdown>(); // Danh sách xe
    private List<dropdown> locationsto = new List<dropdown>(); // điểm khởi hành

    protected override async Task OnInitializedAsync()
    {
        drivers = await httpClient.GetFromJsonAsync<List<dropdown>>("http://localhost:49922/api/Dropdown/driver");

        locationsfrom = await httpClient.GetFromJsonAsync<List<dropdown>>("http://localhost:49922/api/Dropdown/tripfrom");

        cars = await httpClient.GetFromJsonAsync<List<dropdown>>("http://localhost:49922/api/Dropdown/car");

        locationsto = await httpClient.GetFromJsonAsync<List<dropdown>>("http://localhost:49922/api/Dropdown/tripto");
    }

    void Submit()
    {
        if (form.IsValid)
        {
            MudDialog.Close(DialogResult.Ok(SelectedTrip));
        }
    }

    void Cancel()
    {
        MudDialog.Close(DialogResult.Cancel());
    }
}
