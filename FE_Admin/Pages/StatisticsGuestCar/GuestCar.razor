@page "/car-statistics"
@using FE_Admin.Data
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <!-- GCD Statistics Card -->
    <MudCard Class="mb-4">
        <MudCardHeader>
            <MudText Typo="Typo.h6">Thống kê số lần được thuê theo tài xế</MudText>
        </MudCardHeader>
        <MudCardContent>
            @if (isLoading)
            {
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
            }
            else
            {
                <MudTable Items="@gcdStatistics" Dense="true" Hover="true" Striped="true" Bordered="true"
                          Pagination="true" RowsPerPage="5" ServerData="@(new Func<TableState, Task<TableData<statistics_car>>>(ServerReloadGCD))"
                          @ref="gcdTable">
                    <HeaderContent>
                        <MudTh Style="text-align: center">Mã xe</MudTh>
                        <MudTh Style="text-align: center">Tên xe</MudTh>
                        <MudTh Style="text-align: center">Biển số xe</MudTh>
                        <MudTh Style="text-align: center">Chi tiết</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Mã xe" Style="text-align: center">@context.car_code</MudTd>
                        <MudTd DataLabel="Tên tài xế" Style="text-align: center">@context.car_name</MudTd>
                        <MudTd DataLabel="Biển số xe" Style="text-align: center">@context.car_number</MudTd>
                        <MudTd Style="text-align: center">
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                           Color="Color.Primary"
                                           OnClick="@(() => ShowMonthlyGCDDetails(context.id, context.car_name, context.car_number))" />
                        </MudTd>
                    </RowTemplate>
                    <PagerContent>
                        <MudTablePager PageSizeOptions="new int[] { 5, 10, 20, 50 }" />
                    </PagerContent>
                </MudTable>
            }
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    private bool isLoading = true;
    private List<statistics_car> gcdStatistics = new();
    private MudTable<statistics_car> gcdTable;

    protected override async Task OnInitializedAsync()
    {
        await LoadGCDStatistics();
    }

    private async Task<TableData<statistics_car>> ServerReloadGCD(TableState state)
    {
        await LoadGCDStatistics();

        // Apply pagination
        var totalItems = gcdStatistics.Count;
        var pagedData = gcdStatistics
            .Skip(state.Page * state.PageSize)
            .Take(state.PageSize)
            .ToList();

        return new TableData<statistics_car>()
            {
                TotalItems = totalItems,
                Items = pagedData
            };
    }

    private async Task LoadGCDStatistics()
    {
        try
        {
            isLoading = true;
            var response = await Http.GetAsync("http://localhost:49922/api/StatisticsGuestCar/CarMonthly");
            if (response.IsSuccessStatusCode)
            {
                gcdStatistics = await response.Content.ReadFromJsonAsync<List<statistics_car>>() ?? new();
            }
            else
            {
                Snackbar.Add("Không thể tải dữ liệu thuê xe", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Lỗi: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ShowMonthlyGCDDetails(int carId, string carName, string carNumber)
    {
        var parameters = new DialogParameters
        {
            { "CarId", carId },
            { "CarName", carName },
            { "CarNumber", carNumber },
            { "IsGCD", true }
        };
        await ShowDetailsDialog(parameters);
    }

    private async Task ShowDetailsDialog(DialogParameters parameters)
    {
        var options = new DialogOptions
            {
                MaxWidth = MaxWidth.Medium,
                FullWidth = true,
                CloseButton = true,
                DisableBackdropClick = true
            };
        var dialog = await DialogService.ShowAsync<DetailDialog>("Chi tiết theo tháng", parameters, options);
        await dialog.Result;
    }
}
