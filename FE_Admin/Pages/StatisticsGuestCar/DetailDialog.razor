@using FE_Admin.Data
@inject HttpClient Http
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudContainer Style="max-height: 500px; overflow-y: auto">
            @if (isLoading)
            {
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
            }
            else
            {
                <MudText Typo="Typo.h6" Class="mb-4">
                    @(IsGC ? "Thống kê thuê xe" : "Thống kê số chuyến xe") theo tháng của tài xế @CarName
                </MudText>
                @if (monthlyData.Any() && monthlyData[0] != 0)
                {
                    <MudChart ChartType="ChartType.Line"
                              ChartSeries="@(new List<ChartSeries> {
             new ChartSeries {
                 Name = IsGC ? "Doanh thu" : "Số lần thuê",
                 Data = monthlyData
             }
          })"
                              XAxisLabels="@monthlyLabels"
                              Width="100%"
                              Height="300px"
                              XAxisLines="true"
                              YAxisLines="true" />


                    <MudTable Items="@monthlyStatistics" Dense="true" Hover="true" Striped="true" Class="mt-4">
                        <HeaderContent>
                            <MudTh>Tháng</MudTh>
                            <MudTh Style="text-align: right">Số lần thuê</MudTh>
                            @if (IsGC)
                            {
                                <MudTh Style="text-align: right">Doanh thu (VNĐ)</MudTh>
                            }
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>Tháng @context.Month</MudTd>
                            <MudTd Style="text-align: right">@context.Total</MudTd>
                            @if (IsGC)
                            {
                                <MudTd Style="text-align: right">@string.Format("{0:N0}", context.Revenue)</MudTd>
                            }
                        </RowTemplate>
                        <FooterContent>
                            @if (IsGC)
                            {
                                <MudTd></MudTd>
                                <MudTd Style="text-align: right">
                                    <strong>Tổng: @monthlyStatistics.Sum(x => x.Total)</strong>
                                </MudTd>
                                <MudTd Style="text-align: right">
                                    <strong>Tổng: @string.Format("{0:N0}", monthlyStatistics.Sum(x => x.Revenue)) VNĐ</strong>
                                </MudTd>
                            }
                            else
                            {
                                <MudTd></MudTd>
                                <MudTd Style="text-align: right">
                                    <strong>Tổng: @monthlyStatistics.Sum(x => x.Total)</strong>
                                </MudTd>
                            }
                        </FooterContent>
                    </MudTable>
                }
                else
                {
                    <MudText>Không có dữ liệu thống kê cho tài xế này</MudText>
                }
            }
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="Cancel">Đóng</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public int CarId { get; set; }
    [Parameter] public string CarName { get; set; } = string.Empty;
    [Parameter] public bool IsGC { get; set; }

    private bool isLoading = true;
    private double[] monthlyData = Array.Empty<double>();
    private string[] monthlyLabels = Array.Empty<string>();
    private List<MonthlyStatistic> monthlyStatistics = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadMonthlyData();
    }

    private async Task LoadMonthlyData()
    {
        try
        {
            isLoading = true;
            string endpoint = IsGC
                : $"http://localhost:49922/api/Statistics/Driver_monthly_GCD/{CarId}"
                : $"http://localhost:49922/api/Statistics/Driver_monthly_trip/{CarId}";

            var response = await Http.GetAsync(endpoint);

            if (response.IsSuccessStatusCode)
            {
                var data = await response.Content.ReadFromJsonAsync<List<MonthlyStatistic>>();
                if (data != null && data.Any())
                {
                    // Tạo dữ liệu cho bảng với tất cả các tháng
                    monthlyStatistics = Enumerable.Range(1, 12)
                        .Select(month => new MonthlyStatistic
                            {
                                Month = month,
                                Total = data.FirstOrDefault(m => m.Month == month)?.Total ?? 0,
                                Revenue = IsGC ? data.FirstOrDefault(m => m.Month == month)?.Revenue ?? 0 : 0
                            })
                        .ToList();

                    // Tạo dữ liệu cho biểu đồ - Chỉ lấy các tháng có dữ liệu
                    var dataPoints = data.OrderBy(m => m.Month).ToList();
                    monthlyData = IsGC
                        ? dataPoints.Select(x => (double)x.Revenue).ToArray()
                        : dataPoints.Select(x => (double)x.Total).ToArray();
                    monthlyLabels = dataPoints.Select(x => $"Tháng {x.Month}").ToArray();
                }
                else
                {
                    monthlyData = new double[] { 0 };
                    monthlyLabels = new string[] { "Không có dữ liệu" };
                }
            }
            else
            {
                Snackbar.Add($"Không thể tải dữ liệu. Status code: {response.StatusCode}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Lỗi: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void Cancel() => MudDialog.Cancel();
}
