@inject IJSRuntime js
@inject NavigationManager NavigationManager

<MudContainer Class="pt-5 pb-5">
    <MudAppBar Elevation="1">
        <MudLink Typo="Typo.h4" Href="/" Underline="Underline.None">
            <MudText Typo="Typo.h4" Class="fw-bold text-white">BOXCARS</MudText>
        </MudLink>

        <MudSpacer />
        <MudMenu Style="width:fit-content" ActivationEvent="@MouseEvent.MouseOver" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
            <ActivatorContent>
                <MudChip Style="@($"background:none; color:{Colors.Shades.White};")" T="string">
                    <MudText Class="text-uppercase">
                        <MudIcon Icon="@Icons.Material.Outlined.VideoCameraBack" Size="Size.Medium" Class="mb-1" />
                        Camera
                        <MudIcon Icon="@Icons.Material.Outlined.KeyboardArrowDown" Size="Size.Small" Class="mb-1" />
                    </MudText>
                </MudChip>
            </ActivatorContent>
            <ChildContent>
                <MudMenuItem Href="/getroletask">Xem Camera</MudMenuItem>
                <MudMenuItem Href="/select">Thống kê xe ra vào bãi</MudMenuItem>
            </ChildContent>
        </MudMenu>

        <MudMenu Style="width:fit-content" ActivationEvent="@MouseEvent.MouseOver" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
            <ActivatorContent>
                <MudChip Style="@($"background:none; color:{Colors.Shades.White};")" T="string">
                    <MudText Class="text-uppercase">
                        <MudIcon Icon="@Icons.Material.Outlined.DirectionsCar" Size="Size.Medium" Class="mb-1" />
                        quản lý chung
                        <MudIcon Icon="@Icons.Material.Outlined.KeyboardArrowDown" Size="Size.Small" Class="mb-1" />
                    </MudText>
                </MudChip>
            </ActivatorContent>
            <ChildContent>
                <MudMenuItem Href="/getemp">Danh sách Nhân Viên</MudMenuItem>
                <MudMenuItem Href="/getdriver">Danh sách Tài Xế</MudMenuItem>
                <MudMenuItem Href="/getcar">Danh sách Xe</MudMenuItem>
                <MudMenuItem Href="/getcustomer">Danh sách Khách Hàng</MudMenuItem>
                <MudMenuItem Href="/getcartypes">Danh sách Loại Xe</MudMenuItem>
                <MudMenuItem Href="/getcarbrand">Danh sách Hãng Xe</MudMenuItem>
            </ChildContent>
        </MudMenu>

        <MudMenu Style="width:fit-content" ActivationEvent="@MouseEvent.MouseOver" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
            <ActivatorContent>
                <MudChip Style="@($"background:none; color:{Colors.Shades.White};")" T="string">
                    <MudText Class="text-uppercase">
                        <MudIcon Icon="@Icons.Material.Outlined.SettingsSuggest" Size="Size.Medium" Class="mb-1" />
                        dịch vụ
                        <MudIcon Icon="@Icons.Material.Outlined.KeyboardArrowDown" Size="Size.Small" Class="mb-1" />
                    </MudText>
                </MudChip>
            </ActivatorContent>
            <ChildContent>
                <MudMenuItem Href="@($"/guesttrip")">Hóa đơn Đặt vé</MudMenuItem>
                <MudMenuItem Href="@($"/guestcar")">Hóa đơn Xe</MudMenuItem>
                <MudMenuItem Href="@($"/guestcar")">Hóa đơn Thuê Tài Xế</MudMenuItem>
                <MudMenuItem Href="@($"/guestcar")">Hóa đơn Thuê Tài Xế & Xe</MudMenuItem>
            </ChildContent>
        </MudMenu>

        <MudMenu Style="width:fit-content" ActivationEvent="@MouseEvent.MouseOver" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
            <ActivatorContent>
                <MudChip Style="@($"background:none; color:{Colors.Shades.White};")" T="string">
                    <MudText Class="text-uppercase">
                        <MudIcon Icon="@Icons.Material.Outlined.TravelExplore" Size="Size.Medium" Class="mb-1" />
                        tuyến xe
                        <MudIcon Icon="@Icons.Material.Outlined.KeyboardArrowDown" Size="Size.Small" Class="mb-1" />
                    </MudText>
                </MudChip>
            </ActivatorContent>
            <ChildContent>
                <MudMenuItem Href="/gettrip">Danh sách Chuyến Xe</MudMenuItem>
                <MudMenuItem Href="/getlocation">Danh sách Bến Xe</MudMenuItem>
            </ChildContent>
        </MudMenu>

        <MudMenu Style="width:fit-content" ActivationEvent="@MouseEvent.MouseOver" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
            <ActivatorContent>
                <MudChip Style="@($"background:none; color:{Colors.Shades.White};")" T="string">
                    <MudText Class="text-uppercase">
                        <MudIcon Icon="@Icons.Material.Outlined.Report" Size="Size.Medium" Class="mb-1" />
                        thống kê
                        <MudIcon Icon="@Icons.Material.Outlined.KeyboardArrowDown" Size="Size.Small" Class="mb-1" />
                    </MudText>
                </MudChip>
            </ActivatorContent>
            <ChildContent>
                <MudMenuItem Href="/driver-statistics">Thống kê tài xế</MudMenuItem>
                <MudMenuItem>Danh sách Chuyến Xe</MudMenuItem>
            </ChildContent>
        </MudMenu>
        <MudMenu Style="width:fit-content" ActivationEvent="@MouseEvent.MouseOver" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
            <ActivatorContent>
                <MudChip Style="@($"background:none; color:{Colors.Shades.White};")" T="string">
                    <MudText Class="text-uppercase">
                        <MudIcon Icon="@Icons.Material.Outlined.PostAdd" Size="Size.Medium" Class="mb-1" />
                        khác
                        <MudIcon Icon="@Icons.Material.Outlined.KeyboardArrowDown" Size="Size.Small" Class="mb-1" />
                    </MudText>
                </MudChip>
            </ActivatorContent>
            <ChildContent>
                <MudMenuItem Href="/getnews">Danh sách Tin Tức</MudMenuItem>
                <MudMenuItem Href="/getbanner">Danh sách Banner</MudMenuItem>
                <MudMenuItem>Thêm Xe</MudMenuItem>
            </ChildContent>
        </MudMenu>
        <MudSpacer />
        <MudMenu Style="width:fit-content" ActivationEvent="@MouseEvent.MouseOver" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopCenter">
            <ActivatorContent>
                <MudChip Style="@($"background:none; color:{Colors.Shades.White};")" T="string">
                    <MudImage ObjectFit="ObjectFit.Cover" Height="45" Width="45" Src="https://www.mudblazor.com/images/castle.jpg" Alt="Örebro Slott" Elevation="0" Class="rounded-circle" />
                </MudChip>
            </ActivatorContent>
            <ChildContent>
                <MudMenuItem Href="/profile">
                    <MudIcon Icon="@Icons.Material.Outlined.SupervisedUserCircle" Color="Color.Default" />
                    @fullname
                </MudMenuItem>
                <hr class="m-0" />
                <MudMenuItem>Danh sách Chuyến Xe</MudMenuItem>
            </ChildContent>
        </MudMenu>
    </MudAppBar>

</MudContainer>


<script>
    // Lấy token từ localStorage
    function getAuthToken() {
        return localStorage.getItem("authToken");
    }
</script>


@code {
    private string fullname;
    private bool isInitialized = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !isInitialized)
        {
            isInitialized = true;

            var token = await js.InvokeAsync<string>("localStorage.getItem", "authToken");

            if (!string.IsNullOrEmpty(token))
            {
                try
                {
                    var handler = new System.IdentityModel.Tokens.Jwt.JwtSecurityTokenHandler();

                    if (handler.CanReadToken(token))
                    {
                        var jwtToken = handler.ReadJwtToken(token);

                        var fullnameClaim = jwtToken.Claims.FirstOrDefault(c => c.Type == "fullname");

                        if (fullnameClaim != null)
                        {
                            fullname = fullnameClaim.Value;
                        }
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Lỗi khi giải mã token: {ex.Message}");
                }
            }
            StateHasChanged();
        }
    }

    private async Task Logout()
    {
        await js.InvokeVoidAsync("localStorage.removeItem", "authToken");

        NavigationManager.NavigateTo("/login", true);
    }
}
