@inject IJSRuntime js
@inject NavigationManager NavigationManager

<MudAppBar Elevation="1">
    <MudLink Typo="Typo.h4" Href="/" Underline="Underline.None">
        <MudText Typo="Typo.h4" Class="fw-bold text-white">BOXCARS</MudText>
    </MudLink>

    <MudSpacer />
    <MudMenu Style="width:fit-content" ActivationEvent="@MouseEvent.MouseOver" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
        <ActivatorContent>
            <MudChip Style="@($"background:none; color:{Colors.Shades.White};")" T="string">
                <MudText Class="text-uppercase">
                    <MudIcon Icon="@Icons.Material.Outlined.VideoCameraBack" Size="Size.Medium" Class="mb-1" />
                    Camera
                    <MudIcon Icon="@Icons.Material.Outlined.KeyboardArrowDown" Size="Size.Small" Class="mb-1" />
                </MudText>
            </MudChip>
        </ActivatorContent>
        <ChildContent>
            <MudMenuItem Href="/getroletask">Xem Camera</MudMenuItem>
            <MudMenuItem Href="/select">Thống kê xe ra vào bãi</MudMenuItem>
        </ChildContent>
    </MudMenu>

    <MudMenu Style="width:fit-content" ActivationEvent="@MouseEvent.MouseOver" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
        <ActivatorContent>
            <MudChip Style="@($"background:none; color:{Colors.Shades.White};")" T="string">
                <MudText Class="text-uppercase">
                    <MudIcon Icon="@Icons.Material.Outlined.DirectionsCar" Size="Size.Medium" Class="mb-1" />
                    quản lý chung
                    <MudIcon Icon="@Icons.Material.Outlined.KeyboardArrowDown" Size="Size.Small" Class="mb-1" />
                </MudText>
            </MudChip>
        </ActivatorContent>
        <ChildContent>
            <MudMenuItem Href="/getroletask">Danh sách Nhân Viên</MudMenuItem>
            <MudMenuItem>Thêm Nhân Viên</MudMenuItem>
        </ChildContent>
    </MudMenu>

    <MudMenu Style="width:fit-content" ActivationEvent="@MouseEvent.MouseOver" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
        <ActivatorContent>
            <MudChip Style="@($"background:none; color:{Colors.Shades.White};")" T="string">
                <MudText Class="text-uppercase">
                    <MudIcon Icon="@Icons.Material.Outlined.SettingsSuggest" Size="Size.Medium" Class="mb-1" />
                    dịch vụ
                    <MudIcon Icon="@Icons.Material.Outlined.KeyboardArrowDown" Size="Size.Small" Class="mb-1" />
                </MudText>
            </MudChip>
        </ActivatorContent>
        <ChildContent>
            <MudMenuItem Href="@($"/getDriver")">Danh sách Tài Xế</MudMenuItem>
            <MudMenuItem>Thêm Tài Xế</MudMenuItem>
        </ChildContent>
    </MudMenu>

    <MudMenu Style="width:fit-content" ActivationEvent="@MouseEvent.MouseOver" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
        <ActivatorContent>
            <MudChip Style="@($"background:none; color:{Colors.Shades.White};")" T="string">
                <MudText Class="text-uppercase">
                    <MudIcon Icon="@Icons.Material.Outlined.PostAdd" Size="Size.Medium" Class="mb-1" />
                    bài viết
                    <MudIcon Icon="@Icons.Material.Outlined.KeyboardArrowDown" Size="Size.Small" Class="mb-1" />
                </MudText>
            </MudChip>
        </ActivatorContent>
        <ChildContent>
            <MudMenuItem Href="@($"/getcars")">Danh sách Xe</MudMenuItem>
            <MudMenuItem>Thêm Xe</MudMenuItem>
        </ChildContent>
    </MudMenu>

    <MudMenu Style="width:fit-content" ActivationEvent="@MouseEvent.MouseOver" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
        <ActivatorContent>
            <MudChip Style="@($"background:none; color:{Colors.Shades.White};")" T="string">
                <MudText Class="text-uppercase">
                    <MudIcon Icon="@Icons.Material.Outlined.TravelExplore" Size="Size.Medium" Class="mb-1" />
                    tuyến xe
                    <MudIcon Icon="@Icons.Material.Outlined.KeyboardArrowDown" Size="Size.Small" Class="mb-1" />
                </MudText>
            </MudChip>
        </ActivatorContent>
        <ChildContent>
            <MudMenuItem Href="/getnews">Xem Bài Viết</MudMenuItem>
        </ChildContent>
    </MudMenu>

    <MudMenu Style="width:fit-content" ActivationEvent="@MouseEvent.MouseOver" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
        <ActivatorContent>
            <MudChip Style="@($"background:none; color:{Colors.Shades.White};")" T="string">
                <MudText Class="text-uppercase">
                    <MudIcon Icon="@Icons.Material.Outlined.Report" Size="Size.Medium" Class="mb-1" />
                    thống kê
                    <MudIcon Icon="@Icons.Material.Outlined.KeyboardArrowDown" Size="Size.Small" Class="mb-1" />
                </MudText>
            </MudChip>
        </ActivatorContent>
        <ChildContent>
            <MudMenuItem Href="/getroletask">Danh sách Tuyến Xe</MudMenuItem>
            <MudMenuItem>Danh sách Chuyến Xe</MudMenuItem>
        </ChildContent>
    </MudMenu>
    <MudSpacer />
    <MudMenu Style="width:fit-content" ActivationEvent="@MouseEvent.MouseOver" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopCenter">
        <ActivatorContent>
            <MudChip Style="@($"background:none; color:{Colors.Shades.White};")" T="string">
                <MudImage ObjectFit="ObjectFit.Cover" Height="45" Width="45" Src="https://www.mudblazor.com/images/castle.jpg" Alt="Örebro Slott" Elevation="0" Class="rounded-circle" />
            </MudChip>
        </ActivatorContent>
        <ChildContent>
            <MudMenuItem Href="/getroletask">
                <MudIcon Icon="@Icons.Material.Outlined.SupervisedUserCircle" Color="Color.Default" />
                @fullname
            </MudMenuItem>
            <hr class="m-0" />
            <MudMenuItem>Danh sách Chuyến Xe</MudMenuItem>
        </ChildContent>
    </MudMenu>
</MudAppBar>


<script>
    // Lấy token từ localStorage
    function getAuthToken() {
        return localStorage.getItem("authToken");
    }
</script>


@code {
    private string fullname;
    private bool isInitialized = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !isInitialized)
        {
            isInitialized = true;

            var token = await js.InvokeAsync<string>("localStorage.getItem", "authToken");

            if (!string.IsNullOrEmpty(token))
            {
                try
                {
                    var handler = new System.IdentityModel.Tokens.Jwt.JwtSecurityTokenHandler();

                    if (handler.CanReadToken(token))
                    {
                        var jwtToken = handler.ReadJwtToken(token);

                        var fullnameClaim = jwtToken.Claims.FirstOrDefault(c => c.Type == "fullname");

                        if (fullnameClaim != null)
                        {
                            fullname = fullnameClaim.Value;
                        }
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Lỗi khi giải mã token: {ex.Message}");
                }
            }
            StateHasChanged();
        }
    }

    private async Task Logout()
    {
        await js.InvokeVoidAsync("localStorage.removeItem", "authToken");

        NavigationManager.NavigateTo("/login", true);
    }
}
