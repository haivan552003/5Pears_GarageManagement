@page "/car_history"
@inject HttpClient httpClient
@inject IDialogService DialogService
@inject IJSRuntime js
<MudContainer Class="mt-14 pa-0 fs-18" MaxWidth="MaxWidth.False">
    <MudGrid Class="pa-0">
        <NavProfileUser />

        <MudItem xs="12" md="9">
            <MudGrid Class="pa-0">
                <MudItem xs="12">
                    <MudPaper Elevation="0" Class="mb-3" Style="@($"color:{Colors.Grey.Darken4}; background:{Colors.Grey.Lighten4};")">
                    </MudPaper>
                    <MudPaper Elevation="0">
                        <MudDataGrid Items="@_guestCarDriverHistories"
                                     Dense="true"
                                     Hover="true"
                                     Bordered="true"
                                     Striped="true"
                                     MultiSelection="false">

                            <ToolBarContent>
                                <MudItem xs="4" Class="pb-3">
                                    <MudTextField @bind-Value="_searchString"
                                                  Placeholder="Tìm kiếm..."
                                                  Adornment="Adornment.Start"
                                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                                  Immediate="true" />
                                </MudItem>
                            </ToolBarContent>

                            <Columns>
                                <PropertyColumn Property="x => x.Price" Title="Giá tiền" />
                                <PropertyColumn Property="x => x.car_code" Title="Mã xe" />
                                <PropertyColumn Property="x => x.guest_car_code" Title="Mã hóa đơn" />
                                <PropertyColumn Property="x => x.car_name" Title="Tên xe" />
                                <PropertyColumn Property="x => x.car_number" Title="Biển số xe" />
                                <PropertyColumn Property="x => x.color" Title="Màu xe" />
                                <TemplateColumn Title="Hành động">
                                    <CellTemplate>
                                        @if (context.Item.status == 2 && context.Item.rate == 0 && context.Item.rate_content == null)
                                        {
                                            <MudIconButton Icon="@Icons.Material.Filled.Star"
                                                           Color="Color.Primary"
                                                           Size="Size.Small"
                                                           OnClick="@(() => OpenRatingDialog(context.Item))" />
                                        }
                                        else if (context.Item.status == 5 && context.Item.rate == 0 && context.Item.rate_content == null)
                                        {
                                            <MudIconButton Icon="@Icons.Material.Filled.Star"
                                                           Color="Color.Primary"
                                                           Size="Size.Small"
                                                           OnClick="@(() => OpenRatingDialog(context.Item))" />
                                        }
                                        else if (context.Item.status == 2 && context.Item.rate != 0 && context.Item.rate_content != null)
                                        {
                                            <MudText Typo="Typo.subtitle1">Đã đánh giá </MudText>
                                        }
                                        else if (context.Item.status == 5 && context.Item.rate != 0 && context.Item.rate_content != null)
                                        {
                                            <MudText Typo="Typo.subtitle1">Đã đánh giá </MudText>
                                        }
                                        else @* if (context.Item.status == 1 && context.Item.status== 5) *@
                                        {
                                            <div class="d-flex justify-content-end">
                                                <MudIconButton Icon="@Icons.Material.Filled.Payment" Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" />
                                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                               Class="ml-3"
                                                               Variant="Variant.Filled"
                                                               Color="Color.Error"
                                                               Size="Size.Small"
                                                               OnClick="@(() => OpenDeleteDialog(context.Item))" />
                                            </div>
                                        }
                                    </CellTemplate>
                                </TemplateColumn>
                            </Columns>

                            <PagerContent>
                                <MudDataGridPager />
                            </PagerContent>
                        </MudDataGrid>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudItem>
    </MudGrid>
</MudContainer>
<script>
    // Lấy token từ localStorage
    function getAuthToken() {
        return localStorage.getItem("authToken");
    }

</script>
@code {
    private List<GuestCarHistory> _guestCarDriverHistories = new();
    private string _searchString = "";
    private int _currentUserId = 1; // Lấy từ authentication
    [Parameter] public int id_cus { get; set; }

    private string _rateUrl = "http://localhost:49922/api/Rate/RateGuestCars";
    private string _historyUrl = "http://localhost:49922/api/Rate/GetCustomerGuestCarHistory";

    protected override async Task OnInitializedAsync()
    {
        var token = await js.InvokeAsync<string>("localStorage.getItem", "authToken");

        if (!string.IsNullOrEmpty(token))
        {
            var handler = new System.IdentityModel.Tokens.Jwt.JwtSecurityTokenHandler();
            var jwtToken = handler.ReadJwtToken(token);

            var usernameClaim = jwtToken.Claims.FirstOrDefault(c => c.Type == "id");

            if (usernameClaim != null)
            {
                id_cus = Convert.ToInt16(usernameClaim.Value);
            }
        }
        await LoadGuestCarDriverHistory();
    }

    private async Task LoadGuestCarDriverHistory()
    {
        try
        {
            var response = await httpClient.GetFromJsonAsync<List<GuestCarHistory>>($"{_historyUrl}/{id_cus}");
            _guestCarDriverHistories = response ?? new List<GuestCarHistory>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Lỗi tải lịch sử: {ex.Message}");
        }
    }

    private async Task OpenRatingDialog(GuestCarHistory selectedItem)
    {
        var parameters = new DialogParameters<RateDialog>
        {
            { x => x.ItemId, selectedItem.id },
            { x => x.RateUrl, _rateUrl }
        };

        var dialog = await DialogService.ShowAsync<RateDialog>("Đánh giá Xe", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadGuestCarDriverHistory();
        }
    }

    private async Task OpenDeleteDialog(GuestCarHistory selectedItem)
    {
        var parameters = new DialogParameters
 {
     { "ItemId", selectedItem.id },
     { "DeleteUrl", "http://localhost:49922/api/Rate/Status6_gc" }
 };

        var dialog = await DialogService.ShowAsync<DeleteDialog>("Xác nhận xóa", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadGuestCarDriverHistory();
        }
    }

}