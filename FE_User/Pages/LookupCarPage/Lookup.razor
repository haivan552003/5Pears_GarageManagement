@page "/lookup"
@using System.ComponentModel.DataAnnotations
@using FE_User.Pages.TripPage
@inject HttpClient Http
@inject IDialogService Dialog

<MudGrid Justify="Justify.Center" AlignItems="AlignItems.Center" Class="pt-5">
    <MudItem xs="12" sm="10" md="8">
        <MudCard Class="p-4" Style="width: 100%; border: none;">
            <MudCardContent>
                <MudText Align="Align.Center" Variant="Variant.H6" Class="fw-bold" Style="font-size: 1.25rem!important;" Color="Color.Primary">
                    TRA CỨU THÔNG TIN ĐẶT VÉ
                </MudText>
            </MudCardContent>

            <EditForm Model="@lookupModel" OnValidSubmit="OnSubmit">
                <DataAnnotationsValidator />

                <!-- Số điện thoại -->
                <MudGrid Spacing="3" Class="mb-2">
                    <MudItem xs="12">
                        <MudText Align="Align.Left" Typo="Typo.subtitle1">
                            Số điện thoại
                        </MudText>
                        <MudTextField T="string"
                                      @bind-Value="lookupModel.PhoneNumber"
                                      Variant="Variant.Outlined"
                                      Placeholder="Vui lòng nhập số điện thoại "
                                      Margin="Margin.Dense"
                                      Class="input-field" />
                        <MudText Color="Color.Error" Typo="Typo.body2" Class="validation-message">
                            <ValidationMessage For="@(() => lookupModel.PhoneNumber)" />
                        </MudText>
                    </MudItem>
                </MudGrid>

                <!-- Mã vé xe -->
                <MudGrid Spacing="3" Class="mb-2">
                    <MudItem xs="12">
                        <MudText Align="Align.Left" Typo="Typo.subtitle1">
                            Mã chuyến xe
                        </MudText>
                        <MudTextField T="string"
                                      @bind-Value="lookupModel.TicketCode"
                                      Variant="Variant.Outlined"
                                      Placeholder="Vui lòng nhập mã chuyến xe  "
                                      Margin="Margin.Dense"
                                      Class="input-field" />
                        <MudText Color="Color.Error" Typo="Typo.body2" Class="validation-message">
                            <ValidationMessage For="@(() => lookupModel.TicketCode)" />
                        </MudText>
                    </MudItem>
                </MudGrid>

                <!-- Nút Tra Cứu -->
                <MudGrid Justify="Justify.Center">
                    <MudItem xs="12" Class="text-center">
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   Class="lookup-button"
                                   OnClick="OnSubmit">
                            Tra Cứu
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </EditForm>

            @if (lookupResults != null && lookupResults.Count > 0)
            {
                @foreach (var result in lookupResults)
                {
                    <MudCardContent Class="mb-6 ">
                        <MudGrid Justify="Justify.Center" AlignItems="AlignItems.Center">
                            <MudItem xs="12" sm="10" md="8">
                                <MudCard Class="pa-4" Style="background-color: #FFFFFF; border-radius: 1.25rem; border: 1px solid #DDE2E8; width: 100%;">
                                    <MudText Align="Align.Center" Variant="Variant.H6" Style="font-weight: 600; color: #1976D2;"><strong>THÔNG TIN MUA VÉ</strong></MudText>
                                    <MudDivider Class="mb-4" Style="border-color: #1976D2;" />
                                    <MudGrid>
                                        <!-- Thông tin khách hàng và chuyến đi -->
                                        <MudItem xs="12" md="6">
                                            <MudText Style="font-weight: 600; color: #637280; margin-bottom: 8px;"><strong>Họ và tên:</strong></MudText>
                                            <MudText Style="font-weight: 600; color: #637280; margin-bottom: 8px;"><strong>Số điện thoại:</strong></MudText>
                                            <MudText Style="font-weight: 600; color: #637280; margin-bottom: 8px;"><strong>Email:</strong></MudText>
                                            <MudText Style="font-weight: 600; color: #333333; margin-bottom: 8px; width : 150px"><strong>Ngày khởi hành:</strong></MudText>
                                            <MudText Style="font-weight: 600; color: #333333; margin-bottom: 8px;"><strong>Ngày kết thúc:</strong></MudText>
                                            <MudText Style="font-weight: 600; color: #333333; margin-bottom: 8px;"><strong>Điểm đón:</strong></MudText>
                                            <MudText Style="font-weight: 600; color: #333333; margin-bottom: 8px;"><strong>Điểm đến:</strong></MudText>
                                            <MudText Style="font-weight: 600; color: #333333; margin-bottom: 8px;">
                                                <strong>
                                                    Giá vé:  <MudButton OnClick="@(() => OpenDialogPrice(_policyPrice))" Color="Color.Transparent" Style="min-width: 0; padding: 0;">
                                                        <MudIcon Icon="@Icons.Material.Filled.Info" Color="Color.Warning" Title="Info" />
                                                    </MudButton>
                                                </strong>
                                            </MudText>
                                        </MudItem>
                                        <MudItem xs="12" md="6" Style="display: flex; flex-direction: column; align-items: flex-end;">
                                            <MudText Style="color: #594AE2; margin-bottom: 8px; text-align: right;"><strong>@result.CustomerName</strong></MudText>
                                            <MudText Style="color: #594AE2; margin-bottom: 8px; text-align: right;"><strong>@result.PhoneNumber</strong></MudText>
                                            <MudText Style="color: #594AE2; margin-bottom: 8px; width: 500px; text-align: right;"><strong>@result.Email</strong></MudText>
                                            <MudText Style="color: #D32F2F; margin-bottom: 8px; text-align: right;"><strong>@result.TripStartDate.ToString("dd/MM/yyyy")</strong></MudText>
                                            <MudText Style="color: #594AE2; margin-bottom: 8px; text-align: right;"><strong>@result.TripEndDate.ToString("dd/MM/yyyy")</strong></MudText>
                                            <MudText Style="color: #333333; margin-bottom: 8px; text-align: right;"><strong>@result.TripFrom</strong></MudText>
                                            <MudText Style="color: #333333; margin-bottom: 8px; text-align: right;"><strong>@result.TripTo</strong></MudText>
                                            <MudText Style="color: #D32F2F; margin-bottom: 8px; text-align: right;"><strong>@result.TripPrice</strong></MudText>
                                        </MudItem>
                                    </MudGrid>

                                    <MudDivider Class="my-4" Style="border-color: #594AE2;" />

                                    <!-- Thông tin chuyến đi chi tiết -->
                                    <MudGrid>
                                        <MudItem xs="12" md="6">
                                            <MudText Style="font-weight: 600; color: #637280; margin-bottom: 8px;"><strong>Tên tài xế:</strong></MudText>
                                            <MudText Style="font-weight: 600; color: #637280; margin-bottom: 8px;"><strong>Biển Số xe</strong></MudText>
                                            <MudText Style="font-weight: 600; color: #637280; margin-bottom: 8px;"><strong>Màu xe:</strong></MudText>
                                            <MudText Style="font-weight: 600; color: #637280; margin-bottom: 8px;"><strong>Tên xe:</strong></MudText>
                                            <MudText Style="font-weight: 600; color: #637280; margin-bottom: 8px;"><strong>Số ghế:</strong></MudText>
                                        </MudItem>
                                        <MudItem xs="12" md="6" Style="display: flex; flex-direction: column; align-items: flex-end;">
                                            <MudText Style="color: #594AE2; margin-bottom: 8px; text-align: right;"><strong>@result.DriverName</strong></MudText>
                                            <MudText Style="color: #594AE2; margin-bottom: 8px; text-align: right;"><strong>@result.CarNumber</strong></MudText>
                                            <MudText Style="color: #594AE2; margin-bottom: 8px; text-align: right;"><strong>@result.CarColor</strong></MudText>
                                            <MudText Style="color: #594AE2; margin-bottom: 8px; text-align: right;"><strong>@result.CarName</strong></MudText>
                                            <MudText Style="color: #594AE2; margin-bottom: 8px; text-align: right;"><strong>B01</strong></MudText>
                                        </MudItem>
                                    </MudGrid>

                                    <MudDivider Class="my-4" Style="border-color: #594AE2;" />

                                    <!-- Thông tin thêm -->
                                    <MudGrid>
                                        <MudItem xs="12" Style="margin-bottom: 8px;">
                                            <MudText Style="color: #333333;">Quý khách vui lòng có mặt tại bến xe trước 1 tiếng ngày thường và trước 1h30 vào ngày lễ</MudText>
                                        </MudItem>

                                        <MudItem xs="12" Class="pb-0">
                                            <MudText Style="color: #637280; margin-bottom: 8px;"><strong>Điểm lên xe:</strong></MudText>
                                            <MudText Style="color: #333333; margin-bottom: 8px;">Khách hàng vui lòng có mặt trước 30p tại bến xe</MudText>
                                        </MudItem>

                                        <MudItem xs="12" Class="pb-0">
                                            <MudText Style="color: #637280; margin-bottom: 8px;">
                                                <strong>
                                                    Điểm trả khách:
                                                    <MudButton OnClick="@(() => OpenDialogDown(_policyDown))" Color="Color.Transparent" Style="min-width: 0; padding: 0;">
                                                        <MudIcon Icon="@Icons.Material.Filled.Info" Color="Color.Warning" Title="Info" />
                                                    </MudButton>
                                                </strong>
                                            </MudText>
                                            <MudText Style="color: #333333; margin-bottom: 8px;">Khách hàng vui lòng xuống xe kiểm tra kỷ vật tư các nhân nếu có mất ác khi quý khách xuống xe BOXCARS sẽ không chịu trách nhiệm </MudText>
                                        </MudItem>
                                    </MudGrid>
                                </MudCard>
                            </MudItem>
                        </MudGrid>
                    </MudCardContent>
                }
            }
        </MudCard>
    </MudItem>
</MudGrid>


@code {
    private LookupModel lookupModel = new LookupModel();
    private List<lookup> lookupResults = new List<lookup>();
    private string errorMessage;
    private bool isDialogVisible = false;
    private readonly DialogOptions _policyDown = new() { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall, FullWidth = true };
    private readonly DialogOptions _policyPrice = new() { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall, FullWidth = true };

    private async Task OnSubmit()
    {
        errorMessage = null;
        lookupResults.Clear();
        var response = await Http.GetAsync($"http://localhost:49922/api/Lookup/{lookupModel.PhoneNumber}/{lookupModel.TicketCode}");
        if (response.IsSuccessStatusCode)
        {
            var results = await response.Content.ReadFromJsonAsync<IEnumerable<lookup>>();
            lookupResults = results.ToList();

            if (lookupResults.Count == 0)
            {
                errorMessage = "Không tìm thấy thông tin đặt vé!";
            }
            else
            {
                isDialogVisible = true; // Bật modal khi có dữ liệu
            }
        }
        else
        {
            errorMessage = "Đã xảy ra lỗi khi tra cứu thông tin. Vui lòng thử lại sau.";
        }
    }
    private void CloseModal()
    {
        isDialogVisible = false;
    }

    public class LookupModel
    {
        [Required(ErrorMessage = "Vui lòng nhập số điện thoại")]
        [RegularExpression(@"^(03|05|07|08|09)\d{8}$", ErrorMessage = "Số điện thoại không hợp lệ. Số phải bắt đầu bằng 0 và có đúng 10 chữ số.")]
        public string PhoneNumber { get; set; }

        [Required(ErrorMessage = "Vui lòng nhập mã vé xe")]
        public string? TicketCode { get; set; }
    }

    private Task OpenDialogDown(DialogOptions options)
    {
        return Dialog.ShowAsync<DialogPolicyDown>("Đón trả khách", options);
    }
    private Task OpenDialogPrice(DialogOptions options)
    {
        return Dialog.ShowAsync<DialogPolicyPrice>("Chính sách hủy vé", options);
    }
}
