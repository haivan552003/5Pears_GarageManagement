@page "/login_phone"
@inject HttpClient Http
@inject IJSRuntime js
@inject NavigationManager NavigationManager
@layout EmptyLayout

<MudContainer Class="d-flex justify-content-center mt-16" Style="min-height: 100vh; padding: 0;">
    <MudGrid Class="pa-0" Style="width: 100%; max-width: 100%;">
        <MudItem xs="12" sm="8" md="6" lg="4" Class="mx-auto d-flex justify-content-center">
            <EditForm Model="@model" OnValidSubmit="OnValidSubmit">
                <DataAnnotationsValidator />
                <MudGrid>
                    <MudItem xs="12">
                        <MudCard Class="pl-1 pr-1" Style="border-radius: 8px; width: 100%; width: 400px;">
                            <MudText Typo="Typo.h4" Color="Color.Primary" Class="fw-bold text-center pt-5">BOXCARS</MudText>
                            <MudCardContent>
                                <MudTextField Label="SDT" Class="mt-3"
                                              Variant="Variant.Outlined"
                                              Placeholder="Số điện thoại"
                                              @bind-Value="model.phone_number" For="@(() => model.phone_number)" />
                                <MudTextField Label="Mật khẩu" Class="mt-3"
                                              Variant="Variant.Outlined"
                                              Placeholder="Mật khẩu"
                                              @bind-Value="model.password"
                                              For="@(() => model.phone_number)"
                                              InputType="@PasswordInput"
                                              Adornment="Adornment.End"
                                              AdornmentIcon="@PasswordInputIcon"
                                              OnAdornmentClick="TogglePasswordVisibility"
                                              AdornmentAriaLabel="Show Password" />

                                <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="mx-auto w-100 mt-7">Đăng nhập</MudButton>
                                <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Outlined" Color="Color.Default" StartIcon="@Icons.Material.Filled.PhoneAndroid" IconColor="Color.Secondary" Class="mx-auto w-100 mt-3" Href="/register_phone">
                                    Đăng ký bằng SĐT
                                </MudButton>
                                <MudGrid Class="mt-3 mb-5">
                                    <MudItem xs="3" Class="text-center pa-0">
                                        <MudLink Href="/" Underline="Underline.None">Trang chủ</MudLink>
                                    </MudItem>
                                    <MudItem xs="1" Class="pa-0">
                                        <MudText Color="Color.Default" Class="text-center">|</MudText>
                                    </MudItem>
                                    <MudItem xs="3" Class="text-center pa-0">
                                        <MudLink Href="/register" Underline="Underline.None">Đăng ký</MudLink>
                                    </MudItem>
                                    <MudItem xs="1" Class="pa-0">
                                        <MudText Color="Color.Default" Class="text-center">|</MudText>
                                    </MudItem>
                                    <MudItem xs="4" Class="text-center pa-0">
                                        <MudLink Href="/reset" Underline="Underline.None">Quên mật khẩu</MudLink>
                                    </MudItem>
                                </MudGrid>

                            </MudCardContent>
                            @if (LoginFailed)
                            {
                                <MudAlert Severity="Severity.Error" Class="mt-2">Đăng nhập thất bại. Vui lòng kiểm tra lại thông tin.</MudAlert>
                            }
                        </MudCard>
                    </MudItem>
                </MudGrid>
            </EditForm>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    login_phone model = new login_phone();
    bool LoginFailed;

    private async Task OnValidSubmit(EditContext context)
    {
        try
        {
            // var response = await Http.PostAsJsonAsync("http://localhost:49922/api/Login/gentoken-user_phone", model);
            var response = await Http.PostAsJsonAsync("http://localhost:49922/api/Login/gentoken-user_phone", model);

            if (response.IsSuccessStatusCode)
            {
                var token = await response.Content.ReadAsStringAsync();

                await js.InvokeVoidAsync("localStorage.setItem", "authToken", token);
                StateHasChanged();
                NavigationManager.NavigateTo("/", true);
            }
            else
            {
                LoginFailed = true;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error: " + ex.Message);
            LoginFailed = true;
        }
    }
    private bool isShowPassword = false;
    private InputType PasswordInput => isShowPassword ? InputType.Text : InputType.Password;
    private string PasswordInputIcon => isShowPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;
    private void TogglePasswordVisibility()
    {
        isShowPassword = !isShowPassword;
    }
}
