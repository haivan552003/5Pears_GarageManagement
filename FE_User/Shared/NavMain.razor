@inject IJSRuntime js
@inject NavigationManager NavigationManager

<MudContainer Class="fixed z-60">
    <MudAppBar Elevation="1" Class="pt-2 pb-2">
        <MudLink Typo="Typo.h4" Href="/" Underline="Underline.None">
            <MudText Typo="Typo.h4" Class="fw-bold text-white">BOXCARS</MudText>
        </MudLink>

        <MudSpacer />
        <MudMenu Style="width:fit-content" ActivationEvent="@MouseEvent.MouseOver" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
            <ActivatorContent>
                <MudChip Href="/" Style="@($"background:none; color:{Colors.Shades.White};")" T="string">
                    <MudText Class="text-uppercase">
                        <MudIcon Icon="@Icons.Material.Outlined.Dashboard" Size="Size.Medium" Class="mb-1" />
                        Trang chủ
                    </MudText>
                </MudChip>
            </ActivatorContent>
        </MudMenu>

        <MudMenu Style="width:fit-content" ActivationEvent="@MouseEvent.MouseOver" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
            <ActivatorContent>
                <MudChip Href="" Style="@($"background:none; color:{Colors.Shades.White};")" T="string">
                    <MudText Class="text-uppercase">
                        <MudIcon Icon="@Icons.Material.Outlined.DirectionsBus" Size="Size.Medium" Class="mb-1" />
                        chuyến xe
                    </MudText>
                </MudChip>
            </ActivatorContent>
        </MudMenu>

        <MudMenu Style="width:fit-content" ActivationEvent="@MouseEvent.MouseOver" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
            <ActivatorContent>
                <MudChip Href="" Style="@($"background:none; color:{Colors.Shades.White};")" T="string">
                    <MudText Class="text-uppercase">
                        <MudIcon Icon="@Icons.Material.Outlined.DirectionsCar" Size="Size.Medium" Class="mb-1" />
                        thuê xe
                    </MudText>
                </MudChip>
            </ActivatorContent>
        </MudMenu>

        <MudMenu Style="width:fit-content" ActivationEvent="@MouseEvent.MouseOver" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
            <ActivatorContent>
                <MudChip Href="" Style="@($"background:none; color:{Colors.Shades.White};")" T="string">
                    <MudText Class="text-uppercase">
                        <MudIcon Icon="@Icons.Material.Outlined.People" Size="Size.Medium" Class="mb-1" />
                        thuê tài xế
                    </MudText>
                </MudChip>
            </ActivatorContent>
        </MudMenu>

        <MudMenu Style="width:fit-content" ActivationEvent="@MouseEvent.MouseOver" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
            <ActivatorContent>
                <MudChip Href="" Style="@($"background:none; color:{Colors.Shades.White};")" T="string">
                    <MudText Class="text-uppercase">
                        <MudIcon Icon="@Icons.Material.Outlined.Newspaper" Size="Size.Medium" Class="mb-1" />
                        tin tức
                    </MudText>
                </MudChip>
            </ActivatorContent>
        </MudMenu>
        <MudMenu Style="width:fit-content" ActivationEvent="@MouseEvent.MouseOver" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
            <ActivatorContent>
                <MudChip Href="" Style="@($"background:none; color:{Colors.Shades.White};")" T="string">
                    <MudText Class="text-uppercase">
                        <MudIcon Icon="@Icons.Material.Outlined.Contactless" Size="Size.Medium" Class="mb-1" />
                        giới thiệu
                    </MudText>
                </MudChip>
            </ActivatorContent>
        </MudMenu>
        <MudSpacer />
        @if (!string.IsNullOrEmpty(username))
        {
            <MudMenu Style="width:fit-content" ActivationEvent="@MouseEvent.MouseOver" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopCenter">

                <ActivatorContent>
                    <MudChip Style="@($"background:none; color:{Colors.Shades.White};")" T="string">
                        <MudImage ObjectFit="ObjectFit.Cover" Height="45" Width="45" Src="https://www.mudblazor.com/images/castle.jpg" Alt="Örebro Slott" Elevation="0" Class="rounded-circle" />
                    </MudChip>
                </ActivatorContent>
                <ChildContent>
                    <MudMenuItem Href="/profile">
                        <MudIcon Icon="@Icons.Material.Outlined.SupervisedUserCircle" Color="Color.Default" />
                        Xin chào, @username
                    </MudMenuItem>
                    <hr class="m-0" />
                    <MudMenuItem @onclick="Logout">Đăng xuất</MudMenuItem>
                </ChildContent>
            </MudMenu>
        }
        else
        {
            <MudMenu Style="width:fit-content" ActivationEvent="@MouseEvent.MouseOver" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
                <ActivatorContent>
                    <MudChip Href="/login" Style="@($"background:none; color:{Colors.Shades.White};")" T="string">
                        <MudText Class="text-uppercase">
                            đăng nhập
                        </MudText>
                    </MudChip>
                </ActivatorContent>
            </MudMenu>
            <MudMenu Style="width:fit-content" ActivationEvent="@MouseEvent.MouseOver" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
                <ActivatorContent>
                    <MudChip Href="/register" Style="@($"background:none; color:{Colors.Shades.White};")" T="string">
                        <MudText Class="text-uppercase">
                            đăng ký
                        </MudText>
                    </MudChip>
                </ActivatorContent>
            </MudMenu>
        }
    </MudAppBar>

</MudContainer>

<script>
    // Lấy token từ localStorage
    function getAuthToken() {
        return localStorage.getItem("authToken");
    }

</script>

@code {
    private string username;

    protected override async Task OnInitializedAsync()
    {
        // Lấy JWT token từ localStorage
        var token = await js.InvokeAsync<string>("localStorage.getItem", "authToken");

        if (!string.IsNullOrEmpty(token))
        {
            // Giải mã token
            var handler = new System.IdentityModel.Tokens.Jwt.JwtSecurityTokenHandler();
            var jwtToken = handler.ReadJwtToken(token);

            // Lấy giá trị của 'username' từ payload của token
            var usernameClaim = jwtToken.Claims.FirstOrDefault(c => c.Type == "username");

            if (usernameClaim != null)
            {
                username = usernameClaim.Value;
            }
        }
    }

    private async Task Logout()
    {
        // Xóa token khỏi localStorage
        await js.InvokeVoidAsync("localStorage.removeItem", "authToken");

        // Điều hướng về trang đăng nhập
        NavigationManager.NavigateTo("/", true);
    }
}